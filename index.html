<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trivia Master Leaderboard</title>
  
  <!-- React and ReactDOM from CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  
  <!-- Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Tailwind CSS for styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    
    /* Google sign-in button styles */
    .google-button {
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: white;
      color: #444;
      border-radius: 5px;
      border: thin solid #888;
      box-shadow: 0 2px 4px 0 rgba(0,0,0,.25);
      padding: 10px 20px;
      width: 100%;
      font-weight: 500;
      transition: background-color .218s, border-color .218s, box-shadow .218s;
      cursor: pointer;
    }
    
    .google-button:hover {
      box-shadow: 0 0 3px 3px rgba(66,133,244,.3);
    }
    
    .google-button-icon {
      display: inline-block;
      vertical-align: middle;
      margin-right: 12px;
      width: 18px;
      height: 18px;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <!-- Root element for React to render into -->
  <div id="root"></div>

  <!-- Your component code -->
  <script type="text/babel">
    const TriviaMasterLeaderboard = () => {
      // State variables
      const [user, setUser] = React.useState(null);
      const [userData, setUserData] = React.useState(null);
      const [allTrivias, setAllTrivias] = React.useState([]);
      const [myTrivias, setMyTrivias] = React.useState([]);
      const [selectedTrivia, setSelectedTrivia] = React.useState(null);
      const [leaderboard, setLeaderboard] = React.useState([]);
      const [globalLeaderboard, setGlobalLeaderboard] = React.useState([]);
      const [showLoginForm, setShowLoginForm] = React.useState(false);
      const [showSignUpForm, setShowSignUpForm] = React.useState(false);
      const [showAccountSettings, setShowAccountSettings] = React.useState(false);
      const [email, setEmail] = React.useState('');
      const [password, setPassword] = React.useState('');
      const [confirmPassword, setConfirmPassword] = React.useState('');
      const [signUpEmail, setSignUpEmail] = React.useState('');
      const [signUpUsername, setSignUpUsername] = React.useState('');
      const [signUpPassword, setSignUpPassword] = React.useState('');
      const [signUpConfirmPassword, setSignUpConfirmPassword] = React.useState('');
      const [username, setUsername] = React.useState('');
      const [newPassword, setNewPassword] = React.useState('');
      const [currentPassword, setCurrentPassword] = React.useState('');
      const [errorMessage, setErrorMessage] = React.useState('');
      const [successMessage, setSuccessMessage] = React.useState('');
      const [loadingTrivias, setLoadingTrivias] = React.useState(true);
      const [authToken, setAuthToken] = React.useState('');
      const [showPassword, setShowPassword] = React.useState(false);
      const [showSignUpPassword, setShowSignUpPassword] = React.useState(false);
      const [showSignUpConfirmPassword, setShowSignUpConfirmPassword] = React.useState(false);
      
      // Password reset state variables
      const [showPasswordReset, setShowPasswordReset] = React.useState(false);
      const [resetEmail, setResetEmail] = React.useState('');
      const [resetEmailSent, setResetEmailSent] = React.useState(false);
      
      // Create trivia state variables
      const [showCreateTrivia, setShowCreateTrivia] = React.useState(false);
      const [triviaTitle, setTriviaTitle] = React.useState('');
      const [triviaDescription, setTriviaDescription] = React.useState('');
      const [triviaCreated, setTriviaCreated] = React.useState(false);
      const [createdTriviaId, setCreatedTriviaId] = React.useState(null);
      
      // Question editor state variables
      const [showQuestionEditor, setShowQuestionEditor] = React.useState(false);
      const [editingTriviaId, setEditingTriviaId] = React.useState(null);
      const [editingTriviaTitle, setEditingTriviaTitle] = React.useState('');
      const [currentQuestions, setCurrentQuestions] = React.useState([]);
      const [questionText, setQuestionText] = React.useState('');
      const [option1, setOption1] = React.useState('');
      const [option2, setOption2] = React.useState('');
      const [option3, setOption3] = React.useState('');
      const [option4, setOption4] = React.useState('');
      const [correctOption, setCorrectOption] = React.useState(0);
      const [selectedQuestionIndex, setSelectedQuestionIndex] = React.useState(null);
      const [isEditingQuestion, setIsEditingQuestion] = React.useState(false);
      const [showMyTrivias, setShowMyTrivias] = React.useState(false);

      // Firebase configuration
      const FIREBASE_API_KEY = "AIzaSyDIgbZvfYb2kxazfrZcrddAVEZ7tVdWvhA";
      const FIREBASE_DATABASE_URL = "https://trivia-20b98-default-rtdb.europe-west1.firebasedatabase.app";

      // Google OAuth Client ID
      const GOOGLE_CLIENT_ID = "746384834325-bmbc1ldf236m32gnes75i0b8v4rm6ont.apps.googleusercontent.com";

      // Color palette from the original game
      const colors = {
        darkBg: '#0d1321',
        darkBlue: '#1d2d44',
        mediumBlue: '#3e5c76',
        lightBlue: '#748cab',
        cream: '#f0ebd8',
        white: '#ffffff',
        black: '#000000',
        gray: '#c8c8c8',
        red: '#ff5050',
        green: '#50c878'
      };

      // Check if user is already logged in (via localStorage)
      React.useEffect(() => {
        const savedUser = localStorage.getItem('triviaUser');
        const savedToken = localStorage.getItem('triviaToken');
        
        if (savedUser && savedToken) {
          setUser(JSON.parse(savedUser));
          setAuthToken(savedToken);
          fetchUserData(JSON.parse(savedUser).localId, savedToken);
        }
      }, []);

      // Check URL for Google redirect response
      React.useEffect(() => {
        const checkUrlForGoogleAuth = () => {
          // Check if there's a Google auth response in the URL
          const hash = window.location.hash.substring(1);
          if (hash) {
            const params = new URLSearchParams(hash);
            const accessToken = params.get("access_token");
            const state = params.get("state");
            const storedState = localStorage.getItem('googleAuthState');
            
            if (accessToken && state === storedState) {
              // Use the token to sign in with Firebase
              signInWithGoogleToken(accessToken);
              
              // Clear the URL hash and state from localStorage
              window.history.replaceState({}, document.title, window.location.pathname);
              localStorage.removeItem('googleAuthState');
            }
          }
        };
        
        checkUrlForGoogleAuth();
      }, []);

      // Fetch user data from Firebase
      const fetchUserData = async (userId, token) => {
        try {
          const response = await fetch(`${FIREBASE_DATABASE_URL}/users/${userId}.json?auth=${token}`);
          if (response.ok) {
            const data = await response.json();
            if (data) {
              setUserData(data);
              setUsername(data.username || '');
              
              // Fetch user's trivias after getting user data
              fetchMyTrivias(userId);
            }
          }
        } catch (error) {
          console.error("Error fetching user data:", error);
        }
      };

      // Fetch all trivias
      React.useEffect(() => {
        const fetchTrivias = async () => {
          setLoadingTrivias(true);
          try {
            const response = await fetch(`${FIREBASE_DATABASE_URL}/trivias.json`);
            if (response.ok) {
              const data = await response.json();
              if (data) {
                const triviasList = Object.keys(data).map(key => ({
                  id: key,
                  ...data[key]
                }));
                
                // Sort by play count (most played first)
                triviasList.sort((a, b) => (b.play_count || 0) - (a.play_count || 0));
                
                setAllTrivias(triviasList);
                
                // Select the first trivia by default
                if (triviasList.length > 0 && !selectedTrivia) {
                  setSelectedTrivia(triviasList[0]);
                  fetchLeaderboard(triviasList[0].id);
                }
                
                // Fetch user's trivias if logged in
                if (user) {
                  fetchMyTrivias(user.localId);
                }
              }
            }
          } catch (error) {
            console.error("Error fetching trivias:", error);
          } finally {
            setLoadingTrivias(false);
          }
        };

        fetchTrivias();
        fetchGlobalLeaderboard();
      }, []);
      
      // Handle Google Sign-In
      const handleGoogleSignIn = () => {
        // Generate a random state string to prevent CSRF attacks
        const state = Math.random().toString(36).substring(2, 15);
        localStorage.setItem('googleAuthState', state);
        
        // Prepare the Google OAuth URL
        const googleAuthUrl = new URL("https://accounts.google.com/o/oauth2/v2/auth");
        googleAuthUrl.searchParams.append("client_id", GOOGLE_CLIENT_ID);
        googleAuthUrl.searchParams.append("redirect_uri", window.location.origin);
        googleAuthUrl.searchParams.append("response_type", "token");
        googleAuthUrl.searchParams.append("scope", "email profile");
        googleAuthUrl.searchParams.append("state", state);
        
        // Redirect to Google auth page
        window.location.href = googleAuthUrl.toString();
      };
      
      // Sign in with Google token
      const signInWithGoogleToken = async (accessToken) => {
        try {
          // Get user info from Google
          const response = await fetch(`https://www.googleapis.com/oauth2/v3/userinfo?access_token=${accessToken}`);
          const userInfo = await response.json();
          
          if (response.ok) {
            // Use Firebase Auth REST API to sign in with Google
            const authResponse = await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:signInWithIdp?key=${FIREBASE_API_KEY}`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                postBody: `id_token=${accessToken}&providerId=google.com`,
                requestUri: window.location.origin,
                returnSecureToken: true
              })
            });
            
            const authData = await authResponse.json();
            
            if (authResponse.ok) {
              // Save auth data
              const currentUser = {
                email: authData.email || userInfo.email,
                localId: authData.localId,
                displayName: authData.displayName || userInfo.name
              };
              
              setUser(currentUser);
              setAuthToken(authData.idToken);
              
              // Save to localStorage for persistence
              localStorage.setItem('triviaUser', JSON.stringify(currentUser));
              localStorage.setItem('triviaToken', authData.idToken);
              
              // Check if user exists in our database
              const userRef = await fetch(`${FIREBASE_DATABASE_URL}/users/${authData.localId}.json`);
              const userData = await userRef.json();
              
              if (!userData) {
                // Create user entry if first time login
                const username = authData.displayName || userInfo.name || userInfo.email.split('@')[0];
                await fetch(`${FIREBASE_DATABASE_URL}/users/${authData.localId}.json`, {
                  method: 'PUT',
                  headers: {
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    username: username,
                    email: authData.email || userInfo.email,
                    is_developer: false,
                    stats: {
                      games_played: 0,
                      correct_answers: 0,
                      wrong_answers: 0,
                      high_score: 0
                    }
                  })
                });
              }
              
              // Fetch user data
              fetchUserData(authData.localId, authData.idToken);
              
              setShowLoginForm(false);
              setShowSignUpForm(false);
              setSuccessMessage('Signed in with Google successfully!');
            } else {
              setErrorMessage(authData.error?.message || 'Google login failed');
            }
          }
        } catch (error) {
          console.error("Google login error:", error);
          setErrorMessage('Failed to sign in with Google. Please try again.');
        }
      };

      // Fetch user's trivias
      const fetchMyTrivias = async (userId) => {
        try {
          const response = await fetch(`${FIREBASE_DATABASE_URL}/trivias.json`);
          if (response.ok) {
            const data = await response.json();
            if (data) {
              const triviasList = Object.keys(data)
                .filter(key => data[key].created_by_id === userId)
                .map(key => ({
                  id: key,
                  ...data[key]
                }));
              
              // Sort by most recently created
              triviasList.sort((a, b) => (b.created_at || 0) - (a.created_at || 0));
              
              setMyTrivias(triviasList);
            } else {
              setMyTrivias([]);
            }
          }
        } catch (error) {
          console.error("Error fetching user's trivias:", error);
          setMyTrivias([]);
        }
      };

      // Fetch leaderboard for a specific trivia
      const fetchLeaderboard = async (triviaId) => {
        try {
          const response = await fetch(`${FIREBASE_DATABASE_URL}/leaderboards/${triviaId}.json`);
          if (response.ok) {
            const data = await response.json();
            if (data) {
              // Convert to array and sort by score
              const leaderboardArray = Object.keys(data).map(key => ({
                userId: key,
                ...data[key]
              }));
              
              leaderboardArray.sort((a, b) => b.score - a.score);
              setLeaderboard(leaderboardArray);
            } else {
              setLeaderboard([]);
            }
          }
        } catch (error) {
          console.error("Error fetching leaderboard:", error);
          setLeaderboard([]);
        }
      };

      // Fetch global leaderboard (top users based on high score)
      const fetchGlobalLeaderboard = async () => {
        try {
          const response = await fetch(`${FIREBASE_DATABASE_URL}/users.json`);
          if (response.ok) {
            const data = await response.json();
            if (data) {
              // Convert to array and extract needed data
              const usersArray = Object.keys(data).map(key => ({
                userId: key,
                username: data[key].username,
                highScore: data[key].stats?.high_score || 0,
                gamesPlayed: data[key].stats?.games_played || 0
              }));
              
              // Sort by high score
              usersArray.sort((a, b) => b.highScore - a.highScore);
              
              // Take top 10
              setGlobalLeaderboard(usersArray.slice(0, 10));
            }
          }
        } catch (error) {
          console.error("Error fetching global leaderboard:", error);
        }
      };
      
      // Fetch questions for a trivia
      const fetchQuestionsForTrivia = async (triviaId) => {
        try {
          const response = await fetch(`${FIREBASE_DATABASE_URL}/trivia_questions/${triviaId}.json`);
          if (response.ok) {
            const data = await response.json();
            if (data) {
              // Convert to array
              const questions = Object.keys(data).map(key => ({
                id: key,
                ...data[key]
              }));
              
              setCurrentQuestions(questions);
              return questions;
            } else {
              setCurrentQuestions([]);
              return [];
            }
          }
        } catch (error) {
          console.error("Error fetching questions:", error);
          setCurrentQuestions([]);
          return [];
        }
      };

      // Handle trivia selection
      const handleTriviaSelect = (trivia) => {
        setSelectedTrivia(trivia);
        fetchLeaderboard(trivia.id);
      };

      // Firebase REST Authentication
      const handleLogin = async (e) => {
        e.preventDefault();
        setErrorMessage('');
        setSuccessMessage('');
        
        try {
          let loginEmail = email;
          
          // If username was entered instead of email, find the corresponding email
          if (!email.includes('@')) {
            const response = await fetch(`${FIREBASE_DATABASE_URL}/users.json`);
            if (response.ok) {
              const data = await response.json();
              if (data) {
                let found = false;
                Object.entries(data).forEach(([key, user]) => {
                  if (user.username === email) {
                    loginEmail = user.email;
                    found = true;
                  }
                });
                
                if (!found) {
                  setErrorMessage('Username not found');
                  return;
                }
              }
            }
          }
          
          // Sign in with REST API
          const authResponse = await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:signInWithPassword?key=${FIREBASE_API_KEY}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              email: loginEmail,
              password: password,
              returnSecureToken: true
            })
          });
          
          const authData = await authResponse.json();
          
          if (authResponse.ok) {
            // Save auth data
            const currentUser = {
              email: authData.email,
              localId: authData.localId,
              displayName: authData.displayName
            };
            
            setUser(currentUser);
            setAuthToken(authData.idToken);
            
            // Save to localStorage for persistence
            localStorage.setItem('triviaUser', JSON.stringify(currentUser));
            localStorage.setItem('triviaToken', authData.idToken);
            
            // Fetch user data
            fetchUserData(authData.localId, authData.idToken);
            
            setShowLoginForm(false);
            setEmail('');
            setPassword('');
            setSuccessMessage('Signed in successfully!');
          } else {
            setErrorMessage(authData.error?.message || 'Login failed');
          }
        } catch (error) {
          console.error("Login error:", error);
          setErrorMessage('Login failed. Please try again.');
        }
      };
      
      // Handle sign up
      const handleSignUp = async (e) => {
        e.preventDefault();
        setErrorMessage('');
        setSuccessMessage('');
        
        // Validate inputs
        if (!signUpEmail || !signUpUsername || !signUpPassword || !signUpConfirmPassword) {
          setErrorMessage('All fields are required');
          return;
        }
        
        if (signUpPassword !== signUpConfirmPassword) {
          setErrorMessage('Passwords do not match');
          return;
        }
        
        if (signUpPassword.length < 6) {
          setErrorMessage('Password must be at least 6 characters');
          return;
        }
        
        if (!signUpEmail.includes('@')) {
          setErrorMessage('Invalid email format');
          return;
        }
        
        try {
          // Check if username already exists
          const usersRef = await fetch(`${FIREBASE_DATABASE_URL}/users.json`);
          const usersData = await usersRef.json();
          
          if (usersData) {
            for (const uid in usersData) {
              if (usersData[uid].username === signUpUsername) {
                setErrorMessage('Username already exists');
                return;
              }
              if (usersData[uid].email === signUpEmail) {
                setErrorMessage('Email already exists');
                return;
              }
            }
          }
          
          // Create user with email and password
          const signUpResponse = await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:signUp?key=${FIREBASE_API_KEY}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              email: signUpEmail,
              password: signUpPassword,
              returnSecureToken: true
            })
          });
          
          const signUpData = await signUpResponse.json();
          
          if (signUpResponse.ok) {
            // Save auth data
            const newUser = {
              email: signUpData.email,
              localId: signUpData.localId,
              displayName: signUpUsername
            };
            
            setUser(newUser);
            setAuthToken(signUpData.idToken);
            
            // Save to localStorage for persistence
            localStorage.setItem('triviaUser', JSON.stringify(newUser));
            localStorage.setItem('triviaToken', signUpData.idToken);
            
            // Store additional user info
            await fetch(`${FIREBASE_DATABASE_URL}/users/${signUpData.localId}.json?auth=${signUpData.idToken}`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                username: signUpUsername,
                email: signUpEmail,
                is_developer: false,
                stats: {
                  games_played: 0,
                  correct_answers: 0,
                  wrong_answers: 0,
                  high_score: 0
                }
              })
            });
            
            // Fetch user data
            fetchUserData(signUpData.localId, signUpData.idToken);
            
            setShowSignUpForm(false);
            setSignUpEmail('');
            setSignUpUsername('');
            setSignUpPassword('');
            setSignUpConfirmPassword('');
            setSuccessMessage('Account created successfully!');
          } else {
            setErrorMessage(signUpData.error?.message || 'Sign up failed');
          }
        } catch (error) {
          console.error("Sign up error:", error);
          setErrorMessage('Sign up failed. Please try again.');
        }
      };

      // Handle password reset
      const handlePasswordReset = async (e) => {
        e.preventDefault();
        setErrorMessage('');
        setSuccessMessage('');
        
        if (!resetEmail) return;
        
        try {
          // Send password reset email via Firebase REST API
          const resetResponse = await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:sendOobCode?key=${FIREBASE_API_KEY}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              requestType: 'PASSWORD_RESET',
              email: resetEmail
            })
          });
          
          const resetData = await resetResponse.json();
          
          if (resetResponse.ok) {
            setResetEmailSent(true);
            setSuccessMessage('Password reset email sent!');
          } else {
            setErrorMessage(resetData.error?.message || 'Failed to send reset email');
          }
        } catch (error) {
          console.error("Password reset error:", error);
          setErrorMessage('An error occurred. Please try again.');
        }
      };

      // Handle create trivia
      const handleCreateTrivia = async (e) => {
        e.preventDefault();
        setErrorMessage('');
        setSuccessMessage('');
        
        if (!user || !authToken) {
          setErrorMessage('You must be logged in to create a trivia');
          return;
        }
        
        if (!triviaTitle) {
          setErrorMessage('Title is required');
          return;
        }
        
        try {
          // Create the trivia in Firebase
          const createResponse = await fetch(`${FIREBASE_DATABASE_URL}/trivias.json?auth=${authToken}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              title: triviaTitle,
              description: triviaDescription,
              created_by: userData.username || user.email,
              created_by_id: user.localId,
              created_at: Date.now(),
              question_count: 0,
              play_count: 0
            })
          });
          
          const createData = await createResponse.json();
          
          if (createResponse.ok && createData.name) {
            setCreatedTriviaId(createData.name);
            setTriviaCreated(true);
            setSuccessMessage('Trivia created successfully!');
            
            // Update trivias lists
            fetchMyTrivias(user.localId);
            
            // Reload all trivias
            const response = await fetch(`${FIREBASE_DATABASE_URL}/trivias.json`);
            if (response.ok) {
              const data = await response.json();
              if (data) {
                const triviasList = Object.keys(data).map(key => ({
                  id: key,
                  ...data[key]
                }));
                
                triviasList.sort((a, b) => (b.play_count || 0) - (a.play_count || 0));
                setAllTrivias(triviasList);
              }
            }
          } else {
            setErrorMessage('Failed to create trivia');
          }
        } catch (error) {
          console.error("Create trivia error:", error);
          setErrorMessage('An error occurred. Please try again.');
        }
      };
      
      // Open question editor for a trivia
      const openQuestionEditor = async (triviaId, triviaTitle) => {
        setEditingTriviaId(triviaId);
        setEditingTriviaTitle(triviaTitle);
        await fetchQuestionsForTrivia(triviaId);
        setShowQuestionEditor(true);
        setShowCreateTrivia(false);
        setShowMyTrivias(false);
        
        // Clear question form
        resetQuestionForm();
      };
      
      // Reset question form
      const resetQuestionForm = () => {
        setQuestionText('');
        setOption1('');
        setOption2('');
        setOption3('');
        setOption4('');
        setCorrectOption(0);
        setSelectedQuestionIndex(null);
        setIsEditingQuestion(false);
      };
      
      // Handle add/edit question
      const handleQuestionSubmit = async (e) => {
        e.preventDefault();
        setErrorMessage('');
        
        if (!questionText || !option1 || !option2 || !option3 || !option4) {
          setErrorMessage('All fields are required');
          return;
        }
        
        const options = [option1, option2, option3, option4];
        
        try {
          if (isEditingQuestion && selectedQuestionIndex !== null) {
            // Update existing question
            const question = currentQuestions[selectedQuestionIndex];
            
            const updateResponse = await fetch(`${FIREBASE_DATABASE_URL}/trivia_questions/${editingTriviaId}/${question.id}.json?auth=${authToken}`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                question: questionText,
                options,
                correct: parseInt(correctOption)
              })
            });
            
            if (updateResponse.ok) {
              // Update local questions array
              const updatedQuestions = [...currentQuestions];
              updatedQuestions[selectedQuestionIndex] = {
                ...question,
                question: questionText,
                options,
                correct: parseInt(correctOption)
              };
              setCurrentQuestions(updatedQuestions);
              
              setSuccessMessage('Question updated successfully!');
              resetQuestionForm();
            } else {
              setErrorMessage('Failed to update question');
            }
          } else {
            // Add new question
            const addResponse = await fetch(`${FIREBASE_DATABASE_URL}/trivia_questions/${editingTriviaId}.json?auth=${authToken}`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                question: questionText,
                options,
                correct: parseInt(correctOption)
              })
            });
            
            const addData = await addResponse.json();
            
            if (addResponse.ok && addData.name) {
              // Add to local questions array
              setCurrentQuestions([
                ...currentQuestions,
                {
                  id: addData.name,
                  question: questionText,
                  options,
                  correct: parseInt(correctOption)
                }
              ]);
              
              // Update question count in trivia
              await updateQuestionCount(editingTriviaId, currentQuestions.length + 1);
              
              setSuccessMessage('Question added successfully!');
              resetQuestionForm();
            } else {
              setErrorMessage('Failed to add question');
            }
          }
        } catch (error) {
          console.error("Question operation error:", error);
          setErrorMessage('An error occurred. Please try again.');
        }
      };
      
      // Edit a question
      const editQuestion = (index) => {
        const question = currentQuestions[index];
        setQuestionText(question.question);
        setOption1(question.options[0]);
        setOption2(question.options[1]);
        setOption3(question.options[2]);
        setOption4(question.options[3]);
        setCorrectOption(question.correct);
        setSelectedQuestionIndex(index);
        setIsEditingQuestion(true);
      };
      
      // Delete a question
      const deleteQuestion = async (index) => {
        if (!window.confirm('Are you sure you want to delete this question?')) {
          return;
        }
        
        const question = currentQuestions[index];
        
        try {
          const deleteResponse = await fetch(`${FIREBASE_DATABASE_URL}/trivia_questions/${editingTriviaId}/${question.id}.json?auth=${authToken}`, {
            method: 'DELETE'
          });
          
          if (deleteResponse.ok) {
            // Remove from local questions array
            const updatedQuestions = currentQuestions.filter((_, i) => i !== index);
            setCurrentQuestions(updatedQuestions);
            
            // Update question count in trivia
            await updateQuestionCount(editingTriviaId, updatedQuestions.length);
            
            setSuccessMessage('Question deleted successfully!');
            
            // If editing this question, reset the form
            if (selectedQuestionIndex === index) {
              resetQuestionForm();
            }
          } else {
            setErrorMessage('Failed to delete question');
          }
        } catch (error) {
          console.error("Delete question error:", error);
          setErrorMessage('An error occurred. Please try again.');
        }
      };
      
      // Update question count in trivia
      const updateQuestionCount = async (triviaId, count) => {
        try {
          await fetch(`${FIREBASE_DATABASE_URL}/trivias/${triviaId}.json?auth=${authToken}`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              question_count: count
            })
          });
          
          // Update local trivia lists
          const updatedAllTrivias = allTrivias.map(trivia => 
            trivia.id === triviaId ? { ...trivia, question_count: count } : trivia
          );
          setAllTrivias(updatedAllTrivias);
          
          const updatedMyTrivias = myTrivias.map(trivia => 
            trivia.id === triviaId ? { ...trivia, question_count: count } : trivia
          );
          setMyTrivias(updatedMyTrivias);
        } catch (error) {
          console.error("Update question count error:", error);
        }
      };

      // Handle logout
      const handleLogout = () => {
        setUser(null);
        setUserData(null);
        setAuthToken('');
        localStorage.removeItem('triviaUser');
        localStorage.removeItem('triviaToken');
        setSuccessMessage('Signed out successfully!');
        setShowAccountSettings(false);
        setShowCreateTrivia(false);
        setShowQuestionEditor(false);
        setShowMyTrivias(false);
      };

      // Handle username update
      const handleUsernameUpdate = async (e) => {
        e.preventDefault();
        setErrorMessage('');
        setSuccessMessage('');
        
        if (!user || !authToken) return;
        
        try {
          // Check if username already exists
          const usersResponse = await fetch(`${FIREBASE_DATABASE_URL}/users.json`);
          if (usersResponse.ok) {
            const usersData = await usersResponse.json();
            
            let usernameExists = false;
            Object.entries(usersData).forEach(([key, userData]) => {
              if (key !== user.localId && userData.username === username) {
                usernameExists = true;
              }
            });
            
            if (usernameExists) {
              setErrorMessage('Username already exists');
              return;
            }
            
            // Update username using PATCH request
            const updateResponse = await fetch(`${FIREBASE_DATABASE_URL}/users/${user.localId}.json?auth=${authToken}`, {
              method: 'PATCH',
              body: JSON.stringify({ username })
            });
            
            if (updateResponse.ok) {
              setSuccessMessage('Username updated successfully!');
              
              // Update local user data
              setUserData({
                ...userData,
                username
              });
            } else {
              setErrorMessage('Failed to update username');
            }
          }
        } catch (error) {
          console.error("Username update error:", error);
          setErrorMessage('Failed to update username');
        }
      };

      // Handle password update
      const handlePasswordUpdate = async (e) => {
        e.preventDefault();
        setErrorMessage('');
        setSuccessMessage('');
        
        if (!user || !authToken || !newPassword || !currentPassword) return;
        
        try {
          // Verify current password by re-authenticating
          const verifyResponse = await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:signInWithPassword?key=${FIREBASE_API_KEY}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              email: user.email,
              password: currentPassword,
              returnSecureToken: true
            })
          });
          
          if (!verifyResponse.ok) {
            setErrorMessage('Current password is incorrect');
            return;
          }
          
          // Change password
          const passwordResponse = await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:update?key=${FIREBASE_API_KEY}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              idToken: authToken,
              password: newPassword,
              returnSecureToken: true
            })
          });
          
          const passwordData = await passwordResponse.json();
          
          if (passwordResponse.ok) {
            // Update token if returned
            if (passwordData.idToken) {
              setAuthToken(passwordData.idToken);
              localStorage.setItem('triviaToken', passwordData.idToken);
            }
            
            setNewPassword('');
            setCurrentPassword('');
            setSuccessMessage('Password updated successfully!');
          } else {
            setErrorMessage(passwordData.error?.message || 'Failed to update password');
          }
        } catch (error) {
          console.error("Password update error:", error);
          setErrorMessage('Failed to update password');
        }
      };

      // Reset create trivia form
      const resetCreateTrivia = () => {
        setTriviaTitle('');
        setTriviaDescription('');
        setTriviaCreated(false);
        setCreatedTriviaId(null);
        setShowCreateTrivia(false);
      };

      // Show main content, hide forms/editors
      const showMainContent = () => {
        setShowQuestionEditor(false);
        setShowCreateTrivia(false);
        setShowMyTrivias(false);
        setShowLoginForm(false);
        setShowPasswordReset(false);
        setShowAccountSettings(false);
        setShowSignUpForm(false);
      };

      // Render leaderboard table
      const renderLeaderboard = (entries, global = false) => {
        if (entries.length === 0) {
          return (
            <div className="text-center p-4">
              <p className="text-lg" style={{ color: colors.cream }}>No scores yet</p>
            </div>
          );
        }

        return (
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead>
                <tr style={{ borderBottom: `1px solid ${colors.lightBlue}` }}>
                  <th className="px-4 py-2 text-left" style={{ color: colors.lightBlue }}>Rank</th>
                  <th className="px-4 py-2 text-left" style={{ color: colors.lightBlue }}>Username</th>
                  <th className="px-4 py-2 text-right" style={{ color: colors.lightBlue }}>
                    {global ? 'High Score' : 'Score'}
                  </th>
                  {global && (
                    <th className="px-4 py-2 text-right" style={{ color: colors.lightBlue }}>Games</th>
                  )}
                </tr>
              </thead>
              <tbody>
                {entries.map((entry, index) => (
                  <tr 
                    key={entry.userId} 
                    style={{ 
                      borderBottom: `1px solid ${colors.mediumBlue}`, 
                      backgroundColor: index % 2 === 0 ? colors.darkBlue : 'rgba(29, 45, 68, 0.5)'
                    }}
                  >
                    <td className="px-4 py-3">
                      <div 
                        className="flex items-center justify-center w-8 h-8 rounded-full font-bold"
                        style={{ backgroundColor: colors.lightBlue, color: colors.darkBlue }}
                      >
                        {index + 1}
                      </div>
                    </td>
                    <td className="px-4 py-3" style={{ color: colors.cream }}>{entry.username}</td>
                    <td className="px-4 py-3 text-right" style={{ color: colors.cream }}>
                      {global ? entry.highScore : entry.score}
                    </td>
                    {global && (
                      <td className="px-4 py-3 text-right" style={{ color: colors.cream }}>{entry.gamesPlayed}</td>
                    )}
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        );
      };

      return (
        <div 
          className="min-h-screen p-6" 
          style={{ backgroundColor: colors.darkBg }}
        >
          {/* Header */}
          <header className="mb-8 p-4 rounded-lg" style={{ backgroundColor: colors.darkBlue }}>
            <div className="flex flex-col md:flex-row justify-between items-center">
              <h1 className="text-4xl font-bold mb-4 md:mb-0 cursor-pointer" 
                  style={{ color: colors.cream }}
                  onClick={showMainContent}>
                TRIVIA MASTER
              </h1>
              
              {/* Navigation buttons */}
              <div className="flex flex-wrap gap-3 mb-4 md:mb-0">
                <a 
                  href="https://github.com/CrystalPT/Trivation/releases" 
                  target="_blank" 
                  rel="noopener noreferrer"
                  className="px-4 py-2 rounded-lg text-center"
                  style={{ backgroundColor: colors.mediumBlue, color: colors.cream }}
                >
                  Downloads
                </a>
                
                {user && (
                  <>
                    <button
                      className="px-4 py-2 rounded-lg"
                      style={{ backgroundColor: colors.mediumBlue, color: colors.cream }}
                      onClick={() => {
                        setShowCreateTrivia(true);
                        setShowLoginForm(false);
                        setShowPasswordReset(false);
                        setShowAccountSettings(false);
                        setShowQuestionEditor(false);
                        setShowMyTrivias(false);
                        setShowSignUpForm(false);
                        setTriviaCreated(false);
                      }}
                    >
                      Create Trivia
                    </button>
                    <button
                      className="px-4 py-2 rounded-lg"
                      style={{ backgroundColor: colors.mediumBlue, color: colors.cream }}
                      onClick={() => {
                        setShowMyTrivias(true);
                        setShowCreateTrivia(false);
                        setShowLoginForm(false);
                        setShowPasswordReset(false);
                        setShowAccountSettings(false);
                        setShowQuestionEditor(false);
                        setShowSignUpForm(false);
                      }}
                    >
                      My Trivias
                    </button>
                  </>
                )}
              </div>
              
              {/* User controls */}
              <div>
                {user ? (
                  <div className="flex items-center gap-4 flex-wrap justify-center">
                    <p className="text-lg" style={{ color: colors.cream }}>
                      {userData?.username || user.email}
                    </p>
                    <button
                      className="px-4 py-2 rounded-lg"
                      style={{ backgroundColor: colors.mediumBlue, color: colors.cream }}
                      onClick={() => {
                        setShowAccountSettings(!showAccountSettings);
                        setShowCreateTrivia(false);
                        setShowQuestionEditor(false);
                        setShowMyTrivias(false);
                        setShowLoginForm(false);
                        setShowPasswordReset(false);
                        setShowSignUpForm(false);
                      }}
                    >
                      Account Settings
                    </button>
                    <button
                      className="px-4 py-2 rounded-lg"
                      style={{ backgroundColor: colors.mediumBlue, color: colors.cream }}
                      onClick={handleLogout}
                    >
                      Sign Out
                    </button>
                  </div>
                ) : (
                  <div className="flex gap-2">
                    <button
                      className="px-4 py-2 rounded-lg"
                      style={{ backgroundColor: colors.mediumBlue, color: colors.cream }}
                      onClick={() => {
                        setShowLoginForm(!showLoginForm);
                        setShowPasswordReset(false);
                        setShowCreateTrivia(false);
                        setShowQuestionEditor(false);
                        setShowMyTrivias(false);
                        setShowSignUpForm(false);
                      }}
                    >
                      Sign In
                    </button>
                    <button
                      className="px-4 py-2 rounded-lg"
                      style={{ backgroundColor: colors.green, color: colors.white }}
                      onClick={() => {
                        setShowSignUpForm(true);
                        setShowLoginForm(false);
                        setShowPasswordReset(false);
                        setShowCreateTrivia(false);
                        setShowQuestionEditor(false);
                        setShowMyTrivias(false);
                      }}
                    >
                      Sign Up
                    </button>
                  </div>
                )}
              </div>
            </div>
          </header>

          {/* Messages */}
          {errorMessage && (
            <div className="mb-4 p-3 rounded-lg" style={{ backgroundColor: colors.red, color: colors.white }}>
              {errorMessage}
            </div>
          )}
          {successMessage && (
            <div className="mb-4 p-3 rounded-lg" style={{ backgroundColor: colors.green, color: colors.white }}>
              {successMessage}
            </div>
          )}

          {/* Login Form */}
          {showLoginForm && !user && !showPasswordReset && !showSignUpForm && (
            <div className="mb-8 p-6 rounded-lg max-w-md mx-auto" style={{ backgroundColor: colors.darkBlue }}>
              <h2 className="text-2xl mb-4 text-center" style={{ color: colors.cream }}>Log in</h2>
              <form onSubmit={handleLogin} className="mb-4">
                <div className="mb-4">
                  <label className="block mb-2" style={{ color: colors.lightBlue }}>Username or email</label>
                  <div className="relative">
                    <input
                      type="text"
                      className="w-full p-2 rounded-lg border"
                      style={{ 
                        backgroundColor: colors.darkBg, 
                        color: colors.cream,
                        borderColor: colors.lightBlue 
                      }}
                      value={email}
                      onChange={(e) => setEmail(e.target.value)}
                      required
                    />
                  </div>
                </div>
                <div className="mb-4">
                  <label className="block mb-2" style={{ color: colors.lightBlue }}>Password</label>
                  <div className="relative">
                    <input
                      type={showPassword ? "text" : "password"}
                      className="w-full p-2 pr-10 rounded-lg border"
                      style={{ 
                        backgroundColor: colors.darkBg, 
                        color: colors.cream,
                        borderColor: colors.lightBlue 
                      }}
                      value={password}
                      onChange={(e) => setPassword(e.target.value)}
                      required
                    />
                    <button 
                      type="button"
                      className="absolute inset-y-0 right-0 px-3 flex items-center"
                      onClick={() => setShowPassword(!showPassword)}
                      style={{ color: colors.lightBlue }}
                    >
                      {showPassword ? (
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5">
                          <path strokeLinecap="round" strokeLinejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" />
                        </svg>
                      ) : (
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5">
                          <path strokeLinecap="round" strokeLinejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                          <path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                      )}
                    </button>
                  </div>
                </div>
                <div className="mb-6">
                  <a 
                    href="#" 
                    onClick={(e) => {
                      e.preventDefault();
                      setShowPasswordReset(true);
                      setShowLoginForm(false);
                    }}
                    className="text-sm"
                    style={{ color: colors.lightBlue }}
                  >
                    Forgot password? Reset your password
                  </a>
                </div>
                <button
                  type="submit"
                  className="w-full p-3 rounded-lg mb-4"
                  style={{ backgroundColor: colors.gray, color: colors.darkBg }}
                >
                  Log in
                </button>
                
                <div className="flex items-center my-4">
                  <div className="flex-grow border-t" style={{ borderColor: colors.gray }}></div>
                  <span className="mx-4" style={{ color: colors.cream }}>or</span>
                  <div className="flex-grow border-t" style={{ borderColor: colors.gray }}></div>
                </div>
                
                <button
                  type="button"
                  className="google-button mb-4"
                  onClick={handleGoogleSignIn}
                >
                  <svg className="google-button-icon" viewBox="0 0 48 48">
                    <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
                    <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
                    <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
                    <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
                  </svg>
                  Continue with Google
                </button>
              </form>
              
              <div className="text-center">
                <p style={{ color: colors.cream }}>
                  Don't have an account? 
                  <a 
                    href="#" 
                    onClick={(e) => {
                      e.preventDefault();
                      setShowSignUpForm(true);
                      setShowLoginForm(false);
                    }}
                    className="ml-1"
                    style={{ color: colors.lightBlue }}
                  >
                    Sign up
                  </a>
                </p>
              </div>
            </div>
          )}
          
          {/* Sign Up Form */}
          {showSignUpForm && !user && (
            <div className="mb-8 p-6 rounded-lg max-w-md mx-auto" style={{ backgroundColor: colors.darkBlue }}>
              <h2 className="text-2xl mb-4 text-center" style={{ color: colors.cream }}>Sign up</h2>
              <form onSubmit={handleSignUp} className="mb-4">
                <div className="mb-4">
                  <label className="block mb-2" style={{ color: colors.lightBlue }}>Email</label>
                  <input
                    type="email"
                    className="w-full p-2 rounded-lg border"
                    style={{ 
                      backgroundColor: colors.darkBg, 
                      color: colors.cream,
                      borderColor: colors.lightBlue 
                    }}
                    value={signUpEmail}
                    onChange={(e) => setSignUpEmail(e.target.value)}
                    required
                  />
                </div>
                
                <div className="mb-4">
                  <label className="block mb-2" style={{ color: colors.lightBlue }}>Username</label>
                  <input
                    type="text"
                    className="w-full p-2 rounded-lg border"
                    style={{ 
                      backgroundColor: colors.darkBg, 
                      color: colors.cream,
                      borderColor: colors.lightBlue 
                    }}
                    value={signUpUsername}
                    onChange={(e) => setSignUpUsername(e.target.value)}
                    required
                  />
                </div>
                
                <div className="mb-4">
                  <label className="block mb-2" style={{ color: colors.lightBlue }}>Password</label>
                  <div className="relative">
                    <input
                      type={showSignUpPassword ? "text" : "password"}
                      className="w-full p-2 pr-10 rounded-lg border"
                      style={{ 
                        backgroundColor: colors.darkBg, 
                        color: colors.cream,
                        borderColor: colors.lightBlue 
                      }}
                      value={signUpPassword}
                      onChange={(e) => setSignUpPassword(e.target.value)}
                      required
                    />
                    <button 
                      type="button"
                      className="absolute inset-y-0 right-0 px-3 flex items-center"
                      onClick={() => setShowSignUpPassword(!showSignUpPassword)}
                      style={{ color: colors.lightBlue }}
                    >
                      {showSignUpPassword ? (
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5">
                          <path strokeLinecap="round" strokeLinejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" />
                        </svg>
                      ) : (
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5">
                          <path strokeLinecap="round" strokeLinejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                          <path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                      )}
                    </button>
                  </div>
                </div>
                
                <div className="mb-6">
                  <label className="block mb-2" style={{ color: colors.lightBlue }}>Confirm Password</label>
                  <div className="relative">
                    <input
                      type={showSignUpConfirmPassword ? "text" : "password"}
                      className="w-full p-2 pr-10 rounded-lg border"
                      style={{ 
                        backgroundColor: colors.darkBg, 
                        color: colors.cream,
                        borderColor: colors.lightBlue 
                      }}
                      value={signUpConfirmPassword}
                      onChange={(e) => setSignUpConfirmPassword(e.target.value)}
                      required
                    />
                    <button 
                      type="button"
                      className="absolute inset-y-0 right-0 px-3 flex items-center"
                      onClick={() => setShowSignUpConfirmPassword(!showSignUpConfirmPassword)}
                      style={{ color: colors.lightBlue }}
                    >
                      {showSignUpConfirmPassword ? (
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5">
                          <path strokeLinecap="round" strokeLinejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" />
                        </svg>
                      ) : (
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5">
                          <path strokeLinecap="round" strokeLinejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                          <path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                      )}
                    </button>
                  </div>
                </div>
                
                <button
                  type="submit"
                  className="w-full p-3 rounded-lg mb-4"
                  style={{ backgroundColor: colors.gray, color: colors.darkBg }}
                >
                  Sign up
                </button>
                
                <div className="flex items-center my-4">
                  <div className="flex-grow border-t" style={{ borderColor: colors.gray }}></div>
                  <span className="mx-4" style={{ color: colors.cream }}>or</span>
                  <div className="flex-grow border-t" style={{ borderColor: colors.gray }}></div>
                </div>
                
                <button
                  type="button"
                  className="google-button mb-4"
                  onClick={handleGoogleSignIn}
                >
                  <svg className="google-button-icon" viewBox="0 0 48 48">
                    <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
                    <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
                    <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
                    <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
                  </svg>
                  Continue with Google
                </button>
              </form>
              
              <div className="text-center">
                <p style={{ color: colors.cream }}>
                  Already have an account? 
                  <a 
                    href="#" 
                    onClick={(e) => {
                      e.preventDefault();
                      setShowLoginForm(true);
                      setShowSignUpForm(false);
                    }}
                    className="ml-1"
                    style={{ color: colors.lightBlue }}
                  >
                    Log in
                  </a>
                </p>
              </div>
            </div>
          )}

          {/* Password Reset Form */}
          {showPasswordReset && !user && (
            <div className="mb-8 p-6 rounded-lg max-w-md mx-auto" style={{ backgroundColor: colors.darkBlue }}>
              <h2 className="text-2xl mb-4 text-center" style={{ color: colors.cream }}>Reset Password</h2>
              {!resetEmailSent ? (
                <form onSubmit={handlePasswordReset}>
                  <div className="mb-4">
                    <label className="block mb-2" style={{ color: colors.lightBlue }}>
                      Enter your email address
                    </label>
                    <input
                      type="email"
                      className="w-full p-2 rounded-lg border"
                      style={{ 
                        backgroundColor: colors.darkBg, 
                        color: colors.cream,
                        borderColor: colors.lightBlue 
                      }}
                      value={resetEmail}
                      onChange={(e) => setResetEmail(e.target.value)}
                      required
                    />
                  </div>
                  <div className="flex gap-3">
                    <button
                      type="submit"
                      className="w-full px-4 py-2 rounded-lg"
                      style={{ backgroundColor: colors.mediumBlue, color: colors.cream }}
                    >
                      Send Reset Link
                    </button>
                    <button
                      type="button"
                      className="px-4 py-2 rounded-lg"
                      style={{ backgroundColor: colors.darkBlue, color: colors.cream, border: `1px solid ${colors.lightBlue}` }}
                      onClick={() => {
                        setShowPasswordReset(false);
                        setResetEmail('');
                        setShowLoginForm(true);
                      }}
                    >
                      Cancel
                    </button>
                  </div>
                </form>
              ) : (
                <div>
                  <p className="mb-4" style={{ color: colors.cream }}>
                    A password reset link has been sent to {resetEmail}.
                  </p>
                  <p className="mb-4" style={{ color: colors.cream }}>
                    Check your email and follow the instructions to reset your password.
                  </p>
                  <button
                    className="w-full px-4 py-2 rounded-lg"
                    style={{ backgroundColor: colors.mediumBlue, color: colors.cream }}
                    onClick={() => {
                      setShowPasswordReset(false);
                      setResetEmailSent(false);
                      setResetEmail('');
                      setShowLoginForm(true);
                    }}
                  >
                    Return to Login
                  </button>
                </div>
              )}
            </div>
          )}

          {/* Create Trivia Form */}
          {showCreateTrivia && user && (
            <div className="mb-8 p-6 rounded-lg" style={{ backgroundColor: colors.darkBlue }}>
              <h2 className="text-2xl mb-4" style={{ color: colors.cream }}>Create New Trivia</h2>
              
              {!triviaCreated ? (
                <form onSubmit={handleCreateTrivia}>
                  <div className="mb-4">
                    <label className="block mb-2" style={{ color: colors.lightBlue }}>Trivia Title</label>
                    <input
                      type="text"
                      className="w-full p-2 rounded-lg border"
                      style={{ 
                        backgroundColor: colors.darkBg, 
                        color: colors.cream,
                        borderColor: colors.lightBlue 
                      }}
                      value={triviaTitle}
                      onChange={(e) => setTriviaTitle(e.target.value)}
                      required
                    />
                  </div>
                  <div className="mb-4">
                    <label className="block mb-2" style={{ color: colors.lightBlue }}>Description</label>
                    <textarea
                      className="w-full p-2 rounded-lg border"
                      style={{ 
                        backgroundColor: colors.darkBg, 
                        color: colors.cream,
                        borderColor: colors.lightBlue,
                        minHeight: '100px'
                      }}
                      value={triviaDescription}
                      onChange={(e) => setTriviaDescription(e.target.value)}
                    ></textarea>
                  </div>
                  <div className="flex gap-3">
                    <button
                      type="submit"
                      className="px-4 py-2 rounded-lg"
                      style={{ backgroundColor: colors.mediumBlue, color: colors.cream }}
                    >
                      Create Trivia
                    </button>
                    <button
                      type="button"
                      className="px-4 py-2 rounded-lg"
                      style={{ backgroundColor: colors.darkBlue, color: colors.cream, border: `1px solid ${colors.lightBlue}` }}
                      onClick={resetCreateTrivia}
                    >
                      Cancel
                    </button>
                  </div>
                </form>
              ) : (
                <div>
                  <p className="mb-4" style={{ color: colors.cream }}>
                    Your trivia "{triviaTitle}" has been created successfully!
                  </p>
                  <div className="flex flex-wrap gap-3">
                    <button
                      className="px-4 py-2 rounded-lg"
                      style={{ backgroundColor: colors.green, color: colors.white }}
                      onClick={() => openQuestionEditor(createdTriviaId, triviaTitle)}
                    >
                      Add Questions Now
                    </button>
                    <button
                      className="px-4 py-2 rounded-lg"
                      style={{ backgroundColor: colors.mediumBlue, color: colors.cream }}
                      onClick={resetCreateTrivia}
                    >
                      Create Another Trivia
                    </button>
                    <button
                      className="px-4 py-2 rounded-lg"
                      style={{ backgroundColor: colors.darkBlue, color: colors.cream, border: `1px solid ${colors.lightBlue}` }}
                      onClick={showMainContent}
                    >
                      Return to Leaderboards
                    </button>
                  </div>
                </div>
              )}
            </div>
          )}

          {/* Question Editor */}
          {showQuestionEditor && user && (
            <div className="mb-8 p-6 rounded-lg" style={{ backgroundColor: colors.darkBlue }}>
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-2xl" style={{ color: colors.cream }}>
                  Questions for: {editingTriviaTitle}
                </h2>
                <button
                  className="px-4 py-2 rounded-lg"
                  style={{ backgroundColor: colors.mediumBlue, color: colors.cream }}
                  onClick={showMainContent}
                >
                  Done
                </button>
              </div>
              
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* Question form */}
                <div className="mb-6">
                  <h3 className="text-xl mb-3" style={{ color: colors.lightBlue }}>
                    {isEditingQuestion ? 'Edit Question' : 'Add New Question'}
                  </h3>
                  <form onSubmit={handleQuestionSubmit}>
                    <div className="mb-4">
                      <label className="block mb-2" style={{ color: colors.lightBlue }}>Question</label>
                      <input
                        type="text"
                        className="w-full p-2 rounded-lg border"
                        style={{ 
                          backgroundColor: colors.darkBg, 
                          color: colors.cream,
                          borderColor: colors.lightBlue 
                        }}
                        value={questionText}
                        onChange={(e) => setQuestionText(e.target.value)}
                        required
                      />
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                      <div>
                        <label className="block mb-2" style={{ color: colors.lightBlue }}>
                          Option 1
                          <input 
                            type="radio" 
                            name="correct" 
                            className="ml-2"
                            checked={correctOption === 0}
                            onChange={() => setCorrectOption(0)}
                          />
                          <span className="ml-1" style={{ color: colors.cream }}>Correct</span>
                        </label>
                        <input
                          type="text"
                          className="w-full p-2 rounded-lg border"
                          style={{ 
                            backgroundColor: colors.darkBg, 
                            color: colors.cream,
                            borderColor: correctOption === 0 ? colors.green : colors.lightBlue 
                          }}
                          value={option1}
                          onChange={(e) => setOption1(e.target.value)}
                          required
                        />
                      </div>
                      
                      <div>
                        <label className="block mb-2" style={{ color: colors.lightBlue }}>
                          Option 2
                          <input 
                            type="radio" 
                            name="correct" 
                            className="ml-2"
                            checked={correctOption === 1}
                            onChange={() => setCorrectOption(1)}
                          />
                          <span className="ml-1" style={{ color: colors.cream }}>Correct</span>
                        </label>
                        <input
                          type="text"
                          className="w-full p-2 rounded-lg border"
                          style={{ 
                            backgroundColor: colors.darkBg, 
                            color: colors.cream,
                            borderColor: correctOption === 1 ? colors.green : colors.lightBlue 
                          }}
                          value={option2}
                          onChange={(e) => setOption2(e.target.value)}
                          required
                        />
                      </div>
                      
                      <div>
                        <label className="block mb-2" style={{ color: colors.lightBlue }}>
                          Option 3
                          <input 
                            type="radio" 
                            name="correct" 
                            className="ml-2"
                            checked={correctOption === 2}
                            onChange={() => setCorrectOption(2)}
                          />
                          <span className="ml-1" style={{ color: colors.cream }}>Correct</span>
                        </label>
                        <input
                          type="text"
                          className="w-full p-2 rounded-lg border"
                          style={{ 
                            backgroundColor: colors.darkBg, 
                            color: colors.cream,
                            borderColor: correctOption === 2 ? colors.green : colors.lightBlue 
                          }}
                          value={option3}
                          onChange={(e) => setOption3(e.target.value)}
                          required
                        />
                      </div>
                      
                      <div>
                        <label className="block mb-2" style={{ color: colors.lightBlue }}>
                          Option 4
                          <input 
                            type="radio" 
                            name="correct" 
                            className="ml-2"
                            checked={correctOption === 3}
                            onChange={() => setCorrectOption(3)}
                          />
                          <span className="ml-1" style={{ color: colors.cream }}>Correct</span>
                        </label>
                        <input
                          type="text"
                          className="w-full p-2 rounded-lg border"
                          style={{ 
                            backgroundColor: colors.darkBg, 
                            color: colors.cream,
                            borderColor: correctOption === 3 ? colors.green : colors.lightBlue 
                          }}
                          value={option4}
                          onChange={(e) => setOption4(e.target.value)}
                          required
                        />
                      </div>
                    </div>
                    
                    <div className="flex gap-3">
                      <button
                        type="submit"
                        className="px-4 py-2 rounded-lg"
                        style={{ backgroundColor: colors.mediumBlue, color: colors.cream }}
                      >
                        {isEditingQuestion ? 'Update Question' : 'Add Question'}
                      </button>
                      {isEditingQuestion && (
                        <button
                          type="button"
                          className="px-4 py-2 rounded-lg"
                          style={{ backgroundColor: colors.darkBlue, color: colors.cream, border: `1px solid ${colors.lightBlue}` }}
                          onClick={resetQuestionForm}
                        >
                          Cancel Edit
                        </button>
                      )}
                    </div>
                  </form>
                </div>
                
                {/* Questions list */}
                <div>
                  <h3 className="text-xl mb-3" style={{ color: colors.lightBlue }}>
                    Questions ({currentQuestions.length})
                  </h3>
                  {currentQuestions.length === 0 ? (
                    <p style={{ color: colors.cream }}>No questions yet. Add your first question!</p>
                  ) : (
                    <div className="max-h-[500px] overflow-y-auto pr-2">
                      {currentQuestions.map((question, index) => (
                        <div 
                          key={question.id} 
                          className="mb-3 p-3 rounded-lg"
                          style={{ backgroundColor: colors.mediumBlue }}
                        >
                          <div className="flex justify-between">
                            <div className="font-bold" style={{ color: colors.cream }}>
                              Q{index + 1}: {question.question}
                            </div>
                            <div className="flex gap-2">
                              <button
                                className="px-2 py-1 rounded-lg text-sm"
                                style={{ backgroundColor: colors.lightBlue, color: colors.darkBlue }}
                                onClick={() => editQuestion(index)}
                              >
                                Edit
                              </button>
                              <button
                                className="px-2 py-1 rounded-lg text-sm"
                                style={{ backgroundColor: colors.red, color: colors.white }}
                                onClick={() => deleteQuestion(index)}
                              >
                                Delete
                              </button>
                            </div>
                          </div>
                          <div className="mt-2">
                            <div style={{ color: question.correct === 0 ? colors.green : colors.cream }}>
                              1. {question.options[0]} {question.correct === 0 && ''}
                            </div>
                            <div style={{ color: question.correct === 1 ? colors.green : colors.cream }}>
                              2. {question.options[1]} {question.correct === 1 && ''}
                            </div>
                            <div style={{ color: question.correct === 2 ? colors.green : colors.cream }}>
                              3. {question.options[2]} {question.correct === 2 && ''}
                            </div>
                            <div style={{ color: question.correct === 3 ? colors.green : colors.cream }}>
                              4. {question.options[3]} {question.correct === 3 && ''}
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            </div>
          )}
          
          {/* My Trivias */}
          {showMyTrivias && user && (
            <div className="mb-8 p-6 rounded-lg" style={{ backgroundColor: colors.darkBlue }}>
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-2xl" style={{ color: colors.cream }}>My Trivias</h2>
                <div className="flex gap-3">
                  <button
                    className="px-4 py-2 rounded-lg"
                    style={{ backgroundColor: colors.green, color: colors.white }}
                    onClick={() => {
                      setShowCreateTrivia(true);
                      setShowMyTrivias(false);
                      setTriviaCreated(false);
                    }}
                  >
                    Create New Trivia
                  </button>
                  <button
                    className="px-4 py-2 rounded-lg"
                    style={{ backgroundColor: colors.mediumBlue, color: colors.cream }}
                    onClick={showMainContent}
                  >
                    Back to Leaderboards
                  </button>
                </div>
              </div>
              
              {myTrivias.length === 0 ? (
                <div className="text-center p-6">
                  <p className="text-xl mb-4" style={{ color: colors.cream }}>You haven't created any trivias yet.</p>
                  <button
                    className="px-4 py-2 rounded-lg"
                    style={{ backgroundColor: colors.green, color: colors.white }}
                    onClick={() => {
                      setShowCreateTrivia(true);
                      setShowMyTrivias(false);
                      setTriviaCreated(false);
                    }}
                  >
                    Create Your First Trivia
                  </button>
                </div>
              ) : (
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                  {myTrivias.map(trivia => (
                    <div 
                      key={trivia.id} 
                      className="p-4 rounded-lg"
                      style={{ backgroundColor: colors.mediumBlue }}
                    >
                      <h3 className="text-xl font-bold mb-1" style={{ color: colors.cream }}>
                        {trivia.title}
                      </h3>
                      {trivia.description && (
                        <p className="mb-2" style={{ color: colors.lightBlue }}>{trivia.description}</p>
                      )}
                      <div className="flex justify-between items-center">
                        <div style={{ color: colors.cream }}>
                          <span className="mr-4">Questions: {trivia.question_count || 0}</span>
                          <span>Plays: {trivia.play_count || 0}</span>
                        </div>
                        <div className="flex gap-2">
                          <button
                            className="px-3 py-1 rounded-lg"
                            style={{ backgroundColor: colors.lightBlue, color: colors.darkBlue }}
                            onClick={() => openQuestionEditor(trivia.id, trivia.title)}
                          >
                            Edit Questions
                          </button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}

          {/* Account Settings */}
          {showAccountSettings && user && (
            <div className="mb-8 p-6 rounded-lg" style={{ backgroundColor: colors.darkBlue }}>
              <h2 className="text-2xl mb-4" style={{ color: colors.cream }}>Account Settings</h2>
              
              {/* Update Username */}
              <div className="mb-6">
                <h3 className="text-xl mb-2" style={{ color: colors.lightBlue }}>Update Username</h3>
                <form onSubmit={handleUsernameUpdate} className="flex gap-4 items-end">
                  <div className="flex-grow">
                    <label className="block mb-2" style={{ color: colors.lightBlue }}>New Username</label>
                    <input
                      type="text"
                      className="w-full p-2 rounded-lg border"
                      style={{ 
                        backgroundColor: colors.darkBg, 
                        color: colors.cream,
                        borderColor: colors.lightBlue 
                      }}
                      value={username}
                      onChange={(e) => setUsername(e.target.value)}
                      required
                    />
                  </div>
                  <button
                    type="submit"
                    className="px-4 py-2 rounded-lg"
                    style={{ backgroundColor: colors.mediumBlue, color: colors.cream }}
                  >
                    Update
                  </button>
                </form>
              </div>
              
              {/* Update Password */}
              <div>
                <h3 className="text-xl mb-2" style={{ color: colors.lightBlue }}>Update Password</h3>
                <form onSubmit={handlePasswordUpdate}>
                  <div className="mb-4">
                    <label className="block mb-2" style={{ color: colors.lightBlue }}>Current Password</label>
                    <input
                      type="password"
                      className="w-full p-2 rounded-lg border"
                      style={{ 
                        backgroundColor: colors.darkBg, 
                        color: colors.cream,
                        borderColor: colors.lightBlue 
                      }}
                      value={currentPassword}
                      onChange={(e) => setCurrentPassword(e.target.value)}
                      required
                    />
                  </div>
                  <div className="mb-4">
                    <label className="block mb-2" style={{ color: colors.lightBlue }}>New Password</label>
                    <input
                      type="password"
                      className="w-full p-2 rounded-lg border"
                      style={{ 
                        backgroundColor: colors.darkBg, 
                        color: colors.cream,
                        borderColor: colors.lightBlue 
                      }}
                      value={newPassword}
                      onChange={(e) => setNewPassword(e.target.value)}
                      required
                    />
                  </div>
                  <button
                    type="submit"
                    className="px-4 py-2 rounded-lg"
                    style={{ backgroundColor: colors.mediumBlue, color: colors.cream }}
                  >
                    Update Password
                  </button>
                </form>
              </div>
            </div>
          )}

          {/* Only show main content if no other panels are active */}
          {!showCreateTrivia && !showQuestionEditor && !showAccountSettings && !showMyTrivias && !showLoginForm && !showPasswordReset && !showSignUpForm && (
            <div className="flex flex-col lg:flex-row gap-8">
              {/* Trivia Leaderboards */}
              <div className="lg:w-2/3 rounded-lg p-6" style={{ backgroundColor: colors.darkBlue }}>
                <h2 className="text-2xl mb-4" style={{ color: colors.cream }}>Trivia Leaderboards</h2>
                
                {/* Trivia Selector */}
                {loadingTrivias ? (
                  <p style={{ color: colors.lightBlue }}>Loading trivias...</p>
                ) : allTrivias.length === 0 ? (
                  <p style={{ color: colors.lightBlue }}>No trivias available</p>
                ) : (
                  <div className="mb-6">
                    <select
                      className="w-full p-3 rounded-lg border"
                      style={{ 
                        backgroundColor: colors.darkBg, 
                        color: colors.cream,
                        borderColor: colors.lightBlue 
                      }}
                      value={selectedTrivia?.id || ''}
                      onChange={(e) => {
                        const selected = allTrivias.find(t => t.id === e.target.value);
                        if (selected) handleTriviaSelect(selected);
                      }}
                    >
                      {allTrivias.map(trivia => (
                        <option key={trivia.id} value={trivia.id}>
                          {trivia.title} ({trivia.question_count || 0} questions, {trivia.play_count || 0} plays)
                        </option>
                      ))}
                    </select>
                  </div>
                )}
                
                {/* Selected Trivia Info */}
                {selectedTrivia && (
                  <div className="mb-6 p-4 rounded-lg" style={{ backgroundColor: colors.mediumBlue }}>
                    <h3 className="text-xl font-bold mb-1" style={{ color: colors.cream }}>
                      {selectedTrivia.title}
                    </h3>
                    <p style={{ color: colors.lightBlue }} className="mb-2">
                      Created by: {selectedTrivia.created_by}
                    </p>
                    {selectedTrivia.description && (
                      <p style={{ color: colors.cream }} className="mb-3">{selectedTrivia.description}</p>
                    )}
                    
                    {/* Action buttons based on ownership */}
                    <div className="flex flex-wrap gap-3">
                      <a 
                        href="https://github.com/CrystalPT/Trivation/releases" 
                        target="_blank" 
                        rel="noopener noreferrer"
                        className="px-4 py-2 rounded-lg inline-block"
                        style={{ backgroundColor: colors.lightBlue, color: colors.darkBlue }}
                      >
                        Download to Play
                      </a>
                      
                      {/* Edit button if user is the creator */}
                      {user && selectedTrivia.created_by_id === user.localId && (
                        <button
                          className="px-4 py-2 rounded-lg"
                          style={{ backgroundColor: colors.cream, color: colors.darkBlue }}
                          onClick={() => openQuestionEditor(selectedTrivia.id, selectedTrivia.title)}
                        >
                          Edit Questions
                        </button>
                      )}
                    </div>
                  </div>
                )}
                
                {/* Leaderboard */}
                {selectedTrivia && renderLeaderboard(leaderboard)}
              </div>
              
              {/* Global Leaderboard */}
              <div className="lg:w-1/3 rounded-lg p-6" style={{ backgroundColor: colors.darkBlue }}>
                <h2 className="text-2xl mb-4" style={{ color: colors.cream }}>Global Leaderboard</h2>
                {renderLeaderboard(globalLeaderboard, true)}
              </div>
            </div>
          )}
        </div>
      );
    };
    
    // Render the component to the DOM
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<TriviaMasterLeaderboard />);
  </script>
</body>
</html>
