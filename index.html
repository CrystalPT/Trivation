<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Triviation</title>

  <!-- Tailwind CSS for styling -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    /* Define color variables */
    :root {
      --dark-bg: #0d1321;
      --dark-blue: #1d2d44;
      --medium-blue: #3e5c76;
      --light-blue: #748cab;
      --cream: #f0ebd8;
      --white: #ffffff;
      --black: #000000;
      --gray: #c8c8c8;
      --red: #ff5050;
      --green: #50c878;
    }

    /* Apply colors with CSS variables */
    .bg-dark-bg { background-color: var(--dark-bg); }
    .bg-dark-blue { background-color: var(--dark-blue); }
    .bg-medium-blue { background-color: var(--medium-blue); }
    .bg-light-blue { background-color: var(--light-blue); }
    .bg-cream { background-color: var(--cream); }
    .bg-red { background-color: var(--red); }
    .bg-green { background-color: var(--green); }

    .text-cream { color: var(--cream); }
    .text-light-blue { color: var(--light-blue); }
    .text-dark-blue { color: var(--dark-blue); }
    .text-white { color: var(--white); }
    .text-dark-bg { color: var(--dark-bg); }
    .text-red { color: var(--red); }

    .border-light-blue { border-color: var(--light-blue); }
    .border-medium-blue { border-color: var(--medium-blue); }
    .border-gray { border-color: var(--gray); }
    .border-green { border-color: var(--green); }

    /* Consistent button styling for better alignment */
    .nav-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.5rem 1rem;
      height: 40px;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-weight: 500;
      transition: background-color 0.2s, transform 0.1s;
      white-space: nowrap;
      border: none;
      cursor: pointer;
    }

    /* Button hover effect */
    .nav-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* Button click effect */
    .nav-button:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    /* Dropdown menu item styling */
    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 15px;
      color: var(--cream);
      transition: background-color 0.2s, color 0.2s;
      text-decoration: none;
    }

    .dropdown-item:hover {
      background-color: var(--medium-blue);
      color: white;
    }

    .dropdown-item:active {
      transform: scale(0.98);
    }

    /* Profile photo container animation */
    #accountDropdownButton {
      transition: transform 0.2s, box-shadow 0.2s;
    }

    #accountDropdownButton:hover {
      transform: scale(1.05);
    }

    #accountDropdownButton:active {
      transform: scale(0.95);
    }

    /* Animation for dropdown menu */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    #accountDropdownMenu.animated {
      animation: fadeIn 0.2s ease-out forwards;
    }

    /* Custom scrollbar for the dropdown if it gets too large */
    #accountDropdownMenu {
      max-height: 80vh;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--medium-blue) var(--dark-blue);
    }

    #accountDropdownMenu::-webkit-scrollbar {
      width: 6px;
    }

    #accountDropdownMenu::-webkit-scrollbar-track {
      background: var(--dark-blue);
    }

    #accountDropdownMenu::-webkit-scrollbar-thumb {
      background-color: var(--medium-blue);
      border-radius: 6px;
    }

    /* Form controls */
    .form-input {
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--light-blue);
      box-shadow: 0 0 0 2px rgba(116, 140, 171, 0.3);
    }

    /* Button styles */
    .form-button {
      transition: transform 0.1s, box-shadow 0.2s;
    }

    .form-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .form-button:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    /* New navigation style with underline effect */
    .nav-link {
      position: relative;
      padding: 0.5rem 1.5rem;
      font-weight: 500;
      transition: color 0.2s;
      color: var(--cream);
      text-decoration: none;
    }

    .nav-link::after {
      content: '';
      position: absolute;
      width: 0;
      height: 3px;
      bottom: -5px;
      left: 0;
      background-color: var(--light-blue);
      transition: width 0.3s ease;
    }

    .nav-link:hover::after {
      width: 100%;
    }

    .nav-link.active::after {
      width: 100%;
    }
  </style>
</head>
<body class="bg-dark-bg">
  <div class="min-h-screen p-6">
    <!-- Header -->
    <header class="mb-8 p-4 rounded-lg bg-dark-blue">
      <div class="flex flex-col md:flex-row justify-between items-center">
        <div class="flex items-center mb-4 md:mb-0">
          <a href="index.html" class="text-4xl font-bold text-cream no-underline">
            TRIVIATION
          </a>
          <a
            href="https://github.com/CrystalPT/Trivation/releases"
            target="_blank"
            rel="noopener noreferrer"
            class="nav-link ml-4"
          >
            Downloads
          </a>
        </div>

        <!-- Navigation buttons with new style -->
        <div class="flex items-center gap-3 mb-4 md:mb-0">
          <a href="index.html" class="nav-link active">Home</a>

          <!-- These links will only be shown when logged in -->
          <div id="loggedInNav" class="flex items-center gap-3" style="display: none;">
            <button
              id="navCreateTrivia"
              class="nav-link">
              Create Trivia
            </button>
            <button
              id="navMyTrivias"
              class="nav-link">
              My Trivias
            </button>
          </div>
        </div>

        <!-- User controls -->
        <div class="flex items-center">
          <div id="loggedOut" class="flex items-center gap-3">
            <a href="login.html" class="nav-button bg-medium-blue text-cream no-underline">
              Sign In
            </a>
            <a href="login.html?page=signup" class="nav-button bg-green text-white no-underline">
              Sign Up
            </a>
          </div>

          <!-- Account Dropdown -->
          <div id="userAccountDropdown" class="relative" style="display: none;">
            <button id="accountDropdownButton" class="flex items-center gap-2 rounded-full focus:outline-none">
              <div id="profilePhotoContainer" class="w-10 h-10 rounded-full overflow-hidden border-2 border-light-blue flex items-center justify-center bg-medium-blue">
                <!-- Default profile icon if no image is set -->
                <span id="defaultProfileIcon" class="text-cream text-lg font-semibold"></span>
                <!-- Profile image will be loaded here if available -->
                <img id="profilePhoto" src="" alt="Profile" class="w-full h-full object-cover" style="display: none;">
              </div>
            </button>

            <!-- Dropdown menu -->
            <div id="accountDropdownMenu" class="absolute right-0 mt-2 w-48 bg-dark-blue border border-light-blue rounded-lg shadow-lg z-50" style="display: none;">
              <div class="p-3 border-b border-medium-blue">
                <p id="dropdownUsername" class="font-semibold text-cream truncate"></p>
                <p id="dropdownEmail" class="text-sm text-light-blue truncate"></p>
              </div>
              <ul class="py-1">
                <li>
                  <a href="account.html" class="dropdown-item">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    Profile settings
                  </a>
                </li>
                <li>
                  <a href="friends.html" class="dropdown-item">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    Friends
                  </a>
                </li>
                <li>
                  <a href="#" class="dropdown-item" id="changeProfilePhotoBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    Change profile photo
                  </a>
                </li>
                <li>
                  <button id="dropdownSignOutBtn" class="dropdown-item text-red w-full text-left">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                    Sign out
                  </button>
                </li>
              </ul>
            </div>

            <!-- Hidden file input for profile photo upload -->
            <input type="file" id="profilePhotoInput" accept="image/jpeg, image/png" style="display: none;">
          </div>
        </div>
      </div>
    </header>

    <!-- Messages -->
    <div id="errorMessage" class="mb-4 p-3 rounded-lg bg-red text-white" style="display: none;"></div>
    <div id="successMessage" class="mb-4 p-3 rounded-lg bg-green text-white" style="display: none;"></div>

    <!-- Main content (Leaderboards) -->
    <div id="mainContent" class="flex flex-col gap-8">
      <div class="flex flex-col lg:flex-row gap-8">
        <!-- Trivia Leaderboards -->
        <div class="lg:w-2/3 rounded-lg p-6 bg-dark-blue">
          <h2 class="text-2xl mb-4 text-cream">Trivia Leaderboards</h2>

          <!-- Trivia Selector -->
          <div id="triviaSelector" class="mb-6">
            <p id="loadingText" class="text-light-blue">Loading trivias...</p>
            <p id="noTriviasText" class="text-light-blue" style="display: none;">No trivias available</p>
            <select
              id="triviaSelect"
              class="w-full p-3 rounded-lg border border-light-blue bg-dark-bg text-cream form-input"
              style="display: none;"
            >
            </select>
          </div>

          <!-- Selected Trivia Info -->
          <div id="selectedTriviaInfo" class="mb-6 p-4 rounded-lg bg-medium-blue" style="display: none;">
            <h3 id="triviaTitle" class="text-xl font-bold mb-1 text-cream"></h3>
            <p id="triviaCreator" class="text-light-blue mb-2"></p>
            <p id="triviaDescription" class="text-cream mb-3"></p>

            <!-- Action buttons -->
            <div class="flex flex-wrap gap-3">
              <a
                href="https://github.com/CrystalPT/Trivation/releases"
                target="_blank"
                rel="noopener noreferrer"
                class="nav-button bg-light-blue text-dark-blue no-underline"
              >
                Download to Play
              </a>
              <button
                id="editQuestionsBtn"
                class="nav-button bg-cream text-dark-blue"
                style="display: none;"
              >
                Edit Questions
              </button>
            </div>
          </div>

          <!-- Leaderboard -->
          <div id="leaderboardContainer"></div>
        </div>

        <!-- Global Leaderboard -->
        <div class="lg:w-1/3 rounded-lg p-6 bg-dark-blue">
          <h2 class="text-2xl mb-4 text-cream">Global Leaderboard</h2>
          <div id="globalLeaderboardContainer"></div>
        </div>
      </div>

      <!-- Community Section -->
      <div class="rounded-lg p-6 bg-dark-blue">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl text-cream">Community</h2>
          <a href="community.html" class="nav-button bg-medium-blue text-cream no-underline">View All Posts</a>
        </div>

        <!-- Recent Community Posts Section -->
        <div id="communityPreview" class="space-y-4">
          <div id="loadingCommunityPosts" class="text-center p-4">
            <p class="text-light-blue">Loading recent posts...</p>
          </div>

          <div id="communityPosts" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" style="display: none;"></div>

          <div id="noPostsMessage" class="text-center p-4" style="display: none;">
            <p class="text-light-blue mb-2">No community posts yet.</p>
            <a href="community.html" class="text-cream hover:underline">Be the first to share!</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Create Trivia Form -->
    <div id="createTriviaContent" class="mb-8 p-6 rounded-lg bg-dark-blue" style="display: none;">
      <h2 class="text-2xl mb-4 text-cream">Create New Trivia</h2>

      <div id="createTriviaStep1">
        <form id="createTriviaForm">
          <div class="mb-4">
            <label class="block mb-2 text-light-blue">Trivia Title</label>
            <input
              type="text"
              id="triviaTitle"
              class="w-full p-2 rounded-lg border bg-dark-bg text-cream border-light-blue form-input"
              required
            />
          </div>
          <div class="mb-4">
            <label class="block mb-2 text-light-blue">Description</label>
            <textarea
              id="triviaDescription"
              class="w-full p-2 rounded-lg border bg-dark-bg text-cream border-light-blue form-input"
              style="min-height: 100px;"
            ></textarea>
          </div>
          <div class="flex gap-3">
            <button
              type="submit"
              class="nav-button bg-medium-blue text-cream"
            >
              Create Trivia
            </button>
            <button
              type="button"
              id="cancelCreateTriviaBtn"
              class="nav-button bg-dark-blue text-cream border border-light-blue"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>

      <div id="createTriviaStep2" style="display: none;">
        <p class="mb-4 text-cream">
          Your trivia "<span id="createdTriviaTitle"></span>" has been created successfully!
        </p>
        <div class="flex flex-wrap gap-3">
          <button
            id="addQuestionsNowBtn"
            class="nav-button bg-green text-white"
          >
            Add Questions Now
          </button>
          <button
            id="createAnotherTriviaBtn"
            class="nav-button bg-medium-blue text-cream"
          >
            Create Another Trivia
          </button>
          <button
            id="backToLeaderboardsBtn"
            class="nav-button bg-dark-blue text-cream border border-light-blue"
          >
            Return to Leaderboards
          </button>
        </div>
      </div>
    </div>

    <!-- My Trivias Section -->
    <div id="myTriviasContent" class="mb-8 p-6 rounded-lg bg-dark-blue" style="display: none;">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl text-cream">My Trivias</h2>
        <div class="flex gap-3">
          <button
            id="myTriviasCreateBtn"
            class="nav-button bg-green text-white"
          >
            Create New Trivia
          </button>
          <button
            id="myTriviasBackBtn"
            class="nav-button bg-medium-blue text-cream"
          >
            Back to Leaderboards
          </button>
        </div>
      </div>

      <div id="myTriviasList" class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <p id="loadingMyTrivias" class="text-cream">Loading your trivias...</p>
        <div id="noTriviasYet" style="display: none;" class="text-center p-6 col-span-2">
          <p class="text-xl mb-4 text-cream">You haven't created any trivias yet.</p>
          <button
            id="createFirstTriviaBtn"
            class="nav-button bg-green text-white"
          >
            Create Your First Trivia
          </button>
        </div>
      </div>
    </div>

    <!-- Question Editor -->
    <div id="questionEditorContent" class="mb-8 p-6 rounded-lg bg-dark-blue" style="display: none;">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl text-cream">
          Questions for: <span id="editingTriviaTitle"></span>
        </h2>
        <div class="flex gap-2">
          <button
            id="backToMyTriviasBtn"
            class="nav-button bg-medium-blue text-cream"
          >
            Back to My Trivias
          </button>
          <button
            id="doneEditingBtn"
            class="nav-button bg-dark-blue text-cream border border-light-blue"
          >
            Done
          </button>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Question form -->
        <div class="mb-6">
          <h3 id="questionFormTitle" class="text-xl mb-3 text-light-blue">
            Add New Question
          </h3>
          <form id="questionForm">
            <div class="mb-4">
              <label class="block mb-2 text-light-blue">Question</label>
              <input
                type="text"
                id="questionText"
                class="w-full p-2 rounded-lg border bg-dark-bg text-cream border-light-blue form-input"
                required
              />
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <label class="block mb-2 text-light-blue">
                  Option 1
                  <input
                    type="radio"
                    name="correctOption"
                    value="0"
                    class="ml-2"
                    checked
                  />
                  <span class="ml-1 text-cream">Correct</span>
                </label>
                <input
                  type="text"
                  id="option1"
                  class="w-full p-2 rounded-lg border bg-dark-bg text-cream border-green form-input"
                  required
                />
              </div>

              <div>
                <label class="block mb-2 text-light-blue">
                  Option 2
                  <input
                    type="radio"
                    name="correctOption"
                    value="1"
                    class="ml-2"
                  />
                  <span class="ml-1 text-cream">Correct</span>
                </label>
                <input
                  type="text"
                  id="option2"
                  class="w-full p-2 rounded-lg border bg-dark-bg text-cream border-light-blue form-input"
                  required
                />
              </div>

              <div>
                <label class="block mb-2 text-light-blue">
                  Option 3
                  <input
                    type="radio"
                    name="correctOption"
                    value="2"
                    class="ml-2"
                  />
                  <span class="ml-1 text-cream">Correct</span>
                </label>
                <input
                  type="text"
                  id="option3"
                  class="w-full p-2 rounded-lg border bg-dark-bg text-cream border-light-blue form-input"
                  required
                />
              </div>

              <div>
                <label class="block mb-2 text-light-blue">
                  Option 4
                  <input
                    type="radio"
                    name="correctOption"
                    value="3"
                    class="ml-2"
                  />
                  <span class="ml-1 text-cream">Correct</span>
                </label>
                <input
                  type="text"
                  id="option4"
                  class="w-full p-2 rounded-lg border bg-dark-bg text-cream border-light-blue form-input"
                  required
                />
              </div>
            </div>

            <div class="flex gap-3">
              <button
                type="submit"
                class="nav-button bg-medium-blue text-cream"
              >
                Add Question
              </button>
              <button
                type="button"
                id="cancelEditBtn"
                class="nav-button bg-dark-blue text-cream border border-light-blue"
                style="display: none;"
              >
                Cancel Edit
              </button>
            </div>
          </form>
        </div>

        <!-- Questions list -->
        <div>
          <h3 class="text-xl mb-3 text-light-blue">
            Questions (<span id="questionCount">0</span>)
          </h3>
          <div id="questionsListEmpty" class="text-cream">No questions yet. Add your first question!</div>
          <div id="questionsList" class="max-h-[500px] overflow-y-auto pr-2"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Firebase configuration
    const FIREBASE_API_KEY = "AIzaSyDIgbZvfYb2kxazfrZcrddAVEZ7tVdWvhA";
    const FIREBASE_DATABASE_URL = "https://trivia-20b98-default-rtdb.europe-west1.firebasedatabase.app";

    // Global state
    let user = null;
    let userData = null;
    let authToken = null;
    let allTrivias = [];
    let selectedTrivia = null;
    let myTrivias = [];
    let currentQuestions = [];
    let editingTriviaId = null;
    let isEditingQuestion = false;
    let selectedQuestionIndex = null;
    let createdTriviaId = null;
    let communityPosts = [];

    // Initialization on page load
    document.addEventListener('DOMContentLoaded', () => {
      // Check URL for page parameter
      const urlParams = new URLSearchParams(window.location.search);
      const page = urlParams.get('page');
      const id = urlParams.get('id');

      // Check authentication state first
      checkAuthState().then(() => {
        // Then determine which page to show
        if (page === 'create-trivia' && user) {
          showCreateTriviaContent();
        } else if (page === 'my-trivias' && user) {
          showMyTriviasContent();
        } else if (page === 'edit-questions' && id && user) {
          editingTriviaId = id;
          showQuestionEditorContent(id);
        } else {
          showMainContent();
        }
      });

      // Add event listeners for navigation
      document.getElementById('navCreateTrivia').addEventListener('click', showCreateTriviaContent);
      document.getElementById('navMyTrivias').addEventListener('click', showMyTriviasContent);

      // Setup account dropdown
      setupAccountDropdown();

      // Create trivia form listeners
      document.getElementById('createTriviaForm').addEventListener('submit', handleCreateTrivia);
      document.getElementById('cancelCreateTriviaBtn').addEventListener('click', showMainContent);
      document.getElementById('createAnotherTriviaBtn').addEventListener('click', resetCreateTriviaForm);
      document.getElementById('backToLeaderboardsBtn').addEventListener('click', showMainContent);
      document.getElementById('addQuestionsNowBtn').addEventListener('click', () => {
        if (createdTriviaId) {
          editingTriviaId = createdTriviaId;
          showQuestionEditorContent(createdTriviaId);
        }
      });

      // My trivias listeners
      document.getElementById('myTriviasCreateBtn').addEventListener('click', showCreateTriviaContent);
      document.getElementById('myTriviasBackBtn').addEventListener('click', showMainContent);
      document.getElementById('createFirstTriviaBtn').addEventListener('click', showCreateTriviaContent);

      // Question editor listeners
      document.getElementById('backToMyTriviasBtn').addEventListener('click', showMyTriviasContent);
      document.getElementById('doneEditingBtn').addEventListener('click', showMainContent);
      document.getElementById('questionForm').addEventListener('submit', handleQuestionSubmit);
      document.getElementById('cancelEditBtn').addEventListener('click', resetQuestionForm);

      // Setup option input borders
      setupOptionInputs();

      // Load community posts for the home page preview
      loadCommunityPostsPreview();
    });

    // Check authentication state
    async function checkAuthState() {
      const savedUser = localStorage.getItem('triviaUser');
      const savedToken = localStorage.getItem('triviaToken');

      if (savedUser && savedToken) {
        user = JSON.parse(savedUser);
        authToken = savedToken;

        // Show logged in UI
        document.getElementById('loggedOut').style.display = 'none';
        document.getElementById('loggedInNav').style.display = 'flex';
        document.getElementById('userAccountDropdown').style.display = 'block';

        // Update user profile in dropdown
        updateUserDropdownInfo();

        // Load user data
        await fetchUserData(user.localId, savedToken);
        return true;
      } else {
        // Show logged out UI
        document.getElementById('loggedOut').style.display = 'flex';
        document.getElementById('loggedInNav').style.display = 'none';
        document.getElementById('userAccountDropdown').style.display = 'none';
        return false;
      }
    }

    // Setup Account Dropdown
    function setupAccountDropdown() {
      // Elements
      const accountDropdownButton = document.getElementById('accountDropdownButton');
      const accountDropdownMenu = document.getElementById('accountDropdownMenu');
      const dropdownSignOutBtn = document.getElementById('dropdownSignOutBtn');
      const changeProfilePhotoBtn = document.getElementById('changeProfilePhotoBtn');
      const profilePhotoInput = document.getElementById('profilePhotoInput');

      // Toggle dropdown when clicking the button
      accountDropdownButton.addEventListener('click', (e) => {
        e.stopPropagation();
        if (accountDropdownMenu.style.display === 'none') {
          accountDropdownMenu.style.display = 'block';
          // Add animation class
          accountDropdownMenu.classList.add('animated');
        } else {
          accountDropdownMenu.style.display = 'none';
        }
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (accountDropdownMenu.style.display !== 'none' &&
            !accountDropdownButton.contains(e.target) &&
            !accountDropdownMenu.contains(e.target)) {
          accountDropdownMenu.style.display = 'none';
        }
      });

      // Sign out functionality
      dropdownSignOutBtn.addEventListener('click', () => {
        handleSignOut();
      });

      // Profile photo change
      changeProfilePhotoBtn.addEventListener('click', (e) => {
        e.preventDefault();
        profilePhotoInput.click();
      });

      // Handle file selection
      profilePhotoInput.addEventListener('change', (e) => {
        if (e.target.files && e.target.files[0]) {
          const file = e.target.files[0];

          // Check file type
          if (!file.type.match('image/jpeg') && !file.type.match('image/png')) {
            showError('Please select a JPEG or PNG image.');
            return;
          }

          // Check file size (limit to 2MB)
          if (file.size > 2 * 1024 * 1024) {
            showError('Image size must be less than 2MB.');
            return;
          }

          const reader = new FileReader();

          reader.onload = function(e) {
            // Display the image
            const profilePhoto = document.getElementById('profilePhoto');
            const defaultProfileIcon = document.getElementById('defaultProfileIcon');
            profilePhoto.src = e.target.result;
            profilePhoto.style.display = 'block';
            defaultProfileIcon.style.display = 'none';

            // Save to localStorage
            localStorage.setItem('profilePhotoData', e.target.result);

            // Option: Upload to server/Firebase if needed
            // uploadProfilePhoto(file);

            // Close dropdown and show success message
            accountDropdownMenu.style.display = 'none';
            showSuccess('Profile photo updated!');
          };

          reader.readAsDataURL(file);
        }
      });
    }

    // Update user info in the dropdown
    function updateUserDropdownInfo() {
      if (!user) return;

      const dropdownUsername = document.getElementById('dropdownUsername');
      const dropdownEmail = document.getElementById('dropdownEmail');
      const defaultProfileIcon = document.getElementById('defaultProfileIcon');
      const profilePhoto = document.getElementById('profilePhoto');

      // Set username and email
      dropdownUsername.textContent = user.displayName || 'User';
      dropdownEmail.textContent = user.email || '';

      // Set initials for default icon
      if (user.displayName) {
        defaultProfileIcon.textContent = user.displayName.substring(0, 1).toUpperCase();
      } else if (user.email) {
        defaultProfileIcon.textContent = user.email.substring(0, 1).toUpperCase();
      } else {
        defaultProfileIcon.textContent = 'U';
      }

      // Check if user has a profile photo
      const savedPhoto = localStorage.getItem('profilePhotoData');
      if (savedPhoto) {
        profilePhoto.src = savedPhoto;
        profilePhoto.style.display = 'block';
        defaultProfileIcon.style.display = 'none';
      } else {
        profilePhoto.style.display = 'none';
        defaultProfileIcon.style.display = 'block';
      }
    }

    // Setup option input borders
    function setupOptionInputs() {
      // Get all radio buttons for correct option
      const correctOptions = document.getElementsByName('correctOption');

      // Add event listener to each radio button
      correctOptions.forEach(option => {
        option.addEventListener('change', updateOptionBorders);
      });

      // Initial setup
      updateOptionBorders();
    }

    // Update option borders based on selected correct option
    function updateOptionBorders() {
      const correctOptionValue = document.querySelector('input[name="correctOption"]:checked').value;

      // Reset all borders
      for (let i = 1; i <= 4; i++) {
        const option = document.getElementById(`option${i}`);
        option.style.borderColor = 'var(--light-blue)';
      }

      // Set green border for correct option
      const correctOption = document.getElementById(`option${parseInt(correctOptionValue) + 1}`);
      correctOption.style.borderColor = 'var(--green)';
    }

    // Fetch user data from Firebase
    async function fetchUserData(userId, token) {
      try {
        const response = await fetch(`${FIREBASE_DATABASE_URL}/users/${userId}.json?auth=${token}`);
        if (response.ok) {
          const data = await response.json();
          if (data) {
            userData = data;

            // If username is available, update display name
            if (data.username) {
              user.displayName = data.username;
              localStorage.setItem('triviaUser', JSON.stringify(user));
              updateUserDropdownInfo();
            }
          }
        }
      } catch (error) {
        console.error("Error fetching user data:", error);
      }
    }

    // Show main content (leaderboards)
    function showMainContent() {
      // Hide other content
      document.getElementById('createTriviaContent').style.display = 'none';
      document.getElementById('myTriviasContent').style.display = 'none';
      document.getElementById('questionEditorContent').style.display = 'none';

      // Show main content
      document.getElementById('mainContent').style.display = 'flex';

      // Load trivias if not already loaded
      if (allTrivias.length === 0) {
        loadTrivias();
        loadGlobalLeaderboard();
      }

      // Update URL without reloading
      history.pushState(null, '', 'index.html');

      // Update active nav button
      updateNavButtons();
    }

    // Show create trivia content
    function showCreateTriviaContent() {
      if (!user) {
        window.location.href = 'login.html?redirect=index.html?page=create-trivia';
        return;
      }

      // Hide other content
      document.getElementById('mainContent').style.display = 'none';
      document.getElementById('myTriviasContent').style.display = 'none';
      document.getElementById('questionEditorContent').style.display = 'none';

      // Show create trivia form
      document.getElementById('createTriviaContent').style.display = 'block';
      document.getElementById('createTriviaStep1').style.display = 'block';
      document.getElementById('createTriviaStep2').style.display = 'none';

      // Update URL without reloading
      history.pushState(null, '', 'index.html?page=create-trivia');

      // Update active nav button
      updateNavButtons('create');
    }

    // Show my trivias content
    function showMyTriviasContent() {
      if (!user) {
        window.location.href = 'login.html?redirect=index.html?page=my-trivias';
        return;
      }

      // Hide other content
      document.getElementById('mainContent').style.display = 'none';
      document.getElementById('createTriviaContent').style.display = 'none';
      document.getElementById('questionEditorContent').style.display = 'none';

      // Show my trivias content
      document.getElementById('myTriviasContent').style.display = 'block';

      // Load user's trivias
      loadMyTrivias();

      // Update URL without reloading
      history.pushState(null, '', 'index.html?page=my-trivias');

      // Update active nav button
      updateNavButtons('my-trivias');
    }

    // Show question editor content
    function showQuestionEditorContent(triviaId) {
      if (!user) {
        window.location.href = 'login.html?redirect=index.html?page=edit-questions&id=' + triviaId;
        return;
      }

      // Hide other content
      document.getElementById('mainContent').style.display = 'none';
      document.getElementById('createTriviaContent').style.display = 'none';
      document.getElementById('myTriviasContent').style.display = 'none';

      // Show question editor content
      document.getElementById('questionEditorContent').style.display = 'block';

      // Load trivia details and questions
      loadTriviaForEditing(triviaId);

      // Reset the question form
      resetQuestionForm();

      // Update URL without reloading
      history.pushState(null, '', 'index.html?page=edit-questions&id=' + triviaId);
    }

    // Update navigation buttons
    function updateNavButtons(active = null) {
      const createBtn = document.getElementById('navCreateTrivia');
      const myTriviasBtn = document.getElementById('navMyTrivias');

      // Reset both buttons
      createBtn.className = 'nav-link';
      myTriviasBtn.className = 'nav-link';

      // Set active button
      if (active === 'create') {
        createBtn.className = 'nav-link active';
      } else if (active === 'my-trivias') {
        myTriviasBtn.className = 'nav-link active';
      }
    }

    // Load all trivias for main page
    async function loadTrivias() {
      try {
        const response = await fetch(`${FIREBASE_DATABASE_URL}/trivias.json`);
        if (response.ok) {
          const data = await response.json();

          document.getElementById('loadingText').style.display = 'none';

          if (data) {
            // Convert to array
            allTrivias = Object.keys(data).map(key => ({
              id: key,
              ...data[key]
            }));

            // Sort by play count (most played first)
            allTrivias.sort((a, b) => (b.play_count || 0) - (a.play_count || 0));

            // Populate dropdown
            const selectElement = document.getElementById('triviaSelect');
            selectElement.innerHTML = '';

            allTrivias.forEach(trivia => {
              const option = document.createElement('option');
              option.value = trivia.id;
              option.textContent = `${trivia.title} (${trivia.question_count || 0} questions, ${trivia.play_count || 0} plays)`;
              selectElement.appendChild(option);
            });

            selectElement.style.display = 'block';

            // Add change event listener
            selectElement.addEventListener('change', (e) => {
              const selected = allTrivias.find(t => t.id === e.target.value);
              if (selected) {
                displayTriviaInfo(selected);
                fetchLeaderboard(selected.id);
              }
            });

            // Select first trivia by default
            if (allTrivias.length > 0) {
              selectElement.value = allTrivias[0].id;
              selectedTrivia = allTrivias[0];
              displayTriviaInfo(allTrivias[0]);
              fetchLeaderboard(allTrivias[0].id);
            }
          } else {
            document.getElementById('noTriviasText').style.display = 'block';
          }
        }
      } catch (error) {
        console.error("Error loading trivias:", error);
        document.getElementById('loadingText').style.display = 'none';
        document.getElementById('noTriviasText').style.display = 'block';
      }
    }

    // Display trivia info
    function displayTriviaInfo(trivia) {
      selectedTrivia = trivia;

      document.getElementById('triviaTitle').textContent = trivia.title;
      document.getElementById('triviaCreator').textContent = `Created by: ${trivia.created_by}`;

      const descElement = document.getElementById('triviaDescription');
      if (trivia.description) {
        descElement.textContent = trivia.description;
        descElement.style.display = 'block';
      } else {
        descElement.style.display = 'none';
      }

      // Show edit button if user is the creator
      const editBtn = document.getElementById('editQuestionsBtn');

      if (user && user.localId === trivia.created_by_id) {
        editBtn.style.display = 'inline-block';
        editBtn.onclick = () => showQuestionEditorContent(trivia.id);
      } else {
        editBtn.style.display = 'none';
      }

      document.getElementById('selectedTriviaInfo').style.display = 'block';
    }

    // Fetch trivia leaderboard
    async function fetchLeaderboard(triviaId) {
      try {
        const response = await fetch(`${FIREBASE_DATABASE_URL}/leaderboards/${triviaId}.json`);
        const container = document.getElementById('leaderboardContainer');

        if (response.ok) {
          const data = await response.json();

          if (data) {
            // Convert to array and sort by score
            const leaderboardArray = Object.keys(data).map(key => ({
              userId: key,
              ...data[key]
            }));

            leaderboardArray.sort((a, b) => b.score - a.score);

            // Render leaderboard
            container.innerHTML = renderLeaderboardHTML(leaderboardArray);
          } else {
            container.innerHTML = '<div class="text-center p-4"><p class="text-lg text-cream">No scores yet</p></div>';
          }
        } else {
          container.innerHTML = '<div class="text-center p-4"><p class="text-lg text-cream">Failed to load leaderboard</p></div>';
        }
      } catch (error) {
        console.error("Error fetching leaderboard:", error);
        document.getElementById('leaderboardContainer').innerHTML =
          '<div class="text-center p-4"><p class="text-lg text-cream">Error loading leaderboard</p></div>';
      }
    }

    // Load global leaderboard
    async function loadGlobalLeaderboard() {
      try {
        const response = await fetch(`${FIREBASE_DATABASE_URL}/users.json`);
        const container = document.getElementById('globalLeaderboardContainer');

        if (response.ok) {
          const data = await response.json();

          if (data) {
            // Convert to array and extract needed data
            const usersArray = Object.keys(data).map(key => ({
              userId: key,
              username: data[key].username,
              highScore: data[key].stats?.high_score || 0,
              gamesPlayed: data[key].stats?.games_played || 0
            }));

            // Sort by high score
            usersArray.sort((a, b) => b.highScore - a.highScore);

            // Take top 10
            const top10 = usersArray.slice(0, 10);

            // Render global leaderboard
            container.innerHTML = renderLeaderboardHTML(top10, true);
          } else {
            container.innerHTML = '<div class="text-center p-4"><p class="text-lg text-cream">No users yet</p></div>';
          }
        } else {
          container.innerHTML = '<div class="text-center p-4"><p class="text-lg text-cream">Failed to load leaderboard</p></div>';
        }
      } catch (error) {
        console.error("Error fetching global leaderboard:", error);
        document.getElementById('globalLeaderboardContainer').innerHTML =
          '<div class="text-center p-4"><p class="text-lg text-cream">Error loading leaderboard</p></div>';
      }
    }

    // Render leaderboard HTML
    function renderLeaderboardHTML(entries, global = false) {
      if (entries.length === 0) {
        return '<div class="text-center p-4"><p class="text-lg text-cream">No scores yet</p></div>';
      }

      let html = `
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead>
              <tr style="border-bottom: 1px solid var(--light-blue)">
                <th class="px-4 py-2 text-left text-light-blue">Rank</th>
                <th class="px-4 py-2 text-left text-light-blue">Username</th>
                <th class="px-4 py-2 text-right text-light-blue">
                  ${global ? 'High Score' : 'Score'}
                </th>
                ${global ? '<th class="px-4 py-2 text-right text-light-blue">Games</th>' : ''}
              </tr>
            </thead>
            <tbody>
      `;

      entries.forEach((entry, index) => {
        const bgColor = index % 2 === 0 ? 'var(--dark-blue)' : 'rgba(29, 45, 68, 0.5)';

        html += `
          <tr style="border-bottom: 1px solid var(--medium-blue); background-color: ${bgColor}">
            <td class="px-4 py-3">
              <div class="flex items-center justify-center w-8 h-8 rounded-full font-bold bg-light-blue text-dark-blue">
                ${index + 1}
              </div>
            </td>
            <td class="px-4 py-3 text-cream">${entry.username}</td>
            <td class="px-4 py-3 text-right text-cream">
              ${global ? entry.highScore : entry.score}
            </td>
            ${global ? `<td class="px-4 py-3 text-right text-cream">${entry.gamesPlayed}</td>` : ''}
          </tr>
        `;
      });

      html += `
            </tbody>
          </table>
        </div>
      `;

      return html;
    }

    // Handle create trivia form submission
    async function handleCreateTrivia(e) {
      e.preventDefault();

      const title = document.getElementById('triviaTitle').value;
      const description = document.getElementById('triviaDescription').value;

      if (!user || !authToken) {
        showError('You must be logged in to create a trivia');
        return;
      }

      if (!title) {
        showError('Title is required');
        return;
      }

      try {
        // Create the trivia in Firebase
        const createResponse = await fetch(`${FIREBASE_DATABASE_URL}/trivias.json?auth=${authToken}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            title: title,
            description: description,
            created_by: userData.username || user.displayName || user.email,
            created_by_id: user.localId,
            created_at: Date.now(),
            question_count: 0,
            play_count: 0
          })
        });

        const createData = await createResponse.json();

        if (createResponse.ok && createData.name) {
          createdTriviaId = createData.name;
          document.getElementById('createdTriviaTitle').textContent = title;
          document.getElementById('createTriviaStep1').style.display = 'none';
          document.getElementById('createTriviaStep2').style.display = 'block';
          showSuccess('Trivia created successfully!');
        } else {
          showError('Failed to create trivia');
        }
      } catch (error) {
        console.error("Create trivia error:", error);
        showError('An error occurred. Please try again.');
      }
    }

    // Reset create trivia form
    function resetCreateTriviaForm() {
      document.getElementById('triviaTitle').value = '';
      document.getElementById('triviaDescription').value = '';
      document.getElementById('createTriviaStep1').style.display = 'block';
      document.getElementById('createTriviaStep2').style.display = 'none';
    }

    // Load user's trivias
    async function loadMyTrivias() {
      if (!user) return;

      try {
        document.getElementById('loadingMyTrivias').style.display = 'block';
        document.getElementById('noTriviasYet').style.display = 'none';
        document.getElementById('myTriviasList').innerHTML = '<p id="loadingMyTrivias" class="text-cream">Loading your trivias...</p>';

        const response = await fetch(`${FIREBASE_DATABASE_URL}/trivias.json`);
        if (response.ok) {
          const data = await response.json();

          document.getElementById('loadingMyTrivias').style.display = 'none';

          if (data) {
            const triviasList = Object.keys(data)
              .filter(key => data[key].created_by_id === user.localId)
              .map(key => ({
                id: key,
                ...data[key]
              }));

            // Sort by most recently created
            triviasList.sort((a, b) => (b.created_at || 0) - (a.created_at || 0));

            myTrivias = triviasList;

            if (triviasList.length === 0) {
              document.getElementById('noTriviasYet').style.display = 'block';
            } else {
              renderMyTrivias(triviasList);
            }
          } else {
            document.getElementById('noTriviasYet').style.display = 'block';
          }
        }
      } catch (error) {
        console.error("Error fetching user's trivias:", error);
        document.getElementById('loadingMyTrivias').style.display = 'none';
        document.getElementById('myTriviasList').innerHTML = '<p class="text-cream">Error loading your trivias</p>';
      }
    }

    // Render user's trivias
    function renderMyTrivias(trivias) {
      const container = document.getElementById('myTriviasList');
      container.innerHTML = '';

      trivias.forEach(trivia => {
        const triviaEl = document.createElement('div');
        triviaEl.className = 'p-4 rounded-lg bg-medium-blue';
        triviaEl.innerHTML = `
          <h3 class="text-xl font-bold mb-1 text-cream">
            ${trivia.title}
          </h3>
          ${trivia.description ? `<p class="mb-2 text-light-blue">${trivia.description}</p>` : ''}
          <div class="flex justify-between items-center">
            <div class="text-cream">
              <span class="mr-4">Questions: ${trivia.question_count || 0}</span>
              <span>Plays: ${trivia.play_count || 0}</span>
            </div>
            <div class="flex gap-2">
              <button
                class="nav-button bg-light-blue text-dark-blue edit-questions-btn"
                data-trivia-id="${trivia.id}"
                data-trivia-title="${trivia.title}"
              >
                Edit Questions
              </button>
            </div>
          </div>
        `;

        container.appendChild(triviaEl);
      });

      // Add event listeners to edit buttons
      document.querySelectorAll('.edit-questions-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const triviaId = btn.getAttribute('data-trivia-id');
          showQuestionEditorContent(triviaId);
        });
      });
    }

    // Load trivia for editing
    async function loadTriviaForEditing(triviaId) {
      try {
        // Get trivia details
        const triviaResponse = await fetch(`${FIREBASE_DATABASE_URL}/trivias/${triviaId}.json`);
        if (triviaResponse.ok) {
          const triviaData = await triviaResponse.json();
          if (triviaData) {
            document.getElementById('editingTriviaTitle').textContent = triviaData.title;

            // Check if user is the creator
            if (!user || user.localId !== triviaData.created_by_id) {
              showError("You don't have permission to edit this trivia");
              showMainContent();
              return;
            }
          }
        }

        // Get questions
        await fetchQuestionsForTrivia(triviaId);
      } catch (error) {
        console.error("Error loading trivia for editing:", error);
        showError("Error loading trivia details");
      }
    }

    // Fetch questions for a trivia
    async function fetchQuestionsForTrivia(triviaId) {
      try {
        const response = await fetch(`${FIREBASE_DATABASE_URL}/trivia_questions/${triviaId}.json`);
        if (response.ok) {
          const data = await response.json();
          if (data) {
            // Convert to array
            currentQuestions = Object.keys(data).map(key => ({
              id: key,
              ...data[key]
            }));

            // Update question count
            document.getElementById('questionCount').textContent = currentQuestions.length;

            // Display questions
            renderQuestionsList();

            return currentQuestions;
          } else {
            currentQuestions = [];
            document.getElementById('questionCount').textContent = '0';
            document.getElementById('questionsListEmpty').style.display = 'block';
            document.getElementById('questionsList').innerHTML = '';
            return [];
          }
        }
      } catch (error) {
        console.error("Error fetching questions:", error);
        currentQuestions = [];
        document.getElementById('questionCount').textContent = '0';
        document.getElementById('questionsListEmpty').style.display = 'block';
        document.getElementById('questionsList').innerHTML = '';
        return [];
      }
    }

    // Render questions list
    function renderQuestionsList() {
      const container = document.getElementById('questionsList');
      container.innerHTML = '';

      if (currentQuestions.length === 0) {
        document.getElementById('questionsListEmpty').style.display = 'block';
        return;
      }

      document.getElementById('questionsListEmpty').style.display = 'none';

      currentQuestions.forEach((question, index) => {
        const questionEl = document.createElement('div');
        questionEl.className = 'mb-3 p-3 rounded-lg bg-medium-blue';

        questionEl.innerHTML = `
          <div class="flex justify-between">
            <div class="font-bold text-cream">
              Q${index + 1}: ${question.question}
            </div>
            <div class="flex gap-2">
              <button
                class="nav-button py-1 px-2 text-sm bg-light-blue text-dark-blue edit-question-btn"
                data-index="${index}"
              >
                Edit
              </button>
              <button
                class="nav-button py-1 px-2 text-sm bg-red text-white delete-question-btn"
                data-index="${index}"
              >
                Delete
              </button>
            </div>
          </div>
          <div class="mt-2">
            <div class="${question.correct === 0 ? 'text-green' : 'text-cream'}">
              1. ${question.options[0]} ${question.correct === 0 ? '✓' : ''}
            </div>
            <div class="${question.correct === 1 ? 'text-green' : 'text-cream'}">
              2. ${question.options[1]} ${question.correct === 1 ? '✓' : ''}
            </div>
            <div class="${question.correct === 2 ? 'text-green' : 'text-cream'}">
              3. ${question.options[2]} ${question.correct === 2 ? '✓' : ''}
            </div>
            <div class="${question.correct === 3 ? 'text-green' : 'text-cream'}">
              4. ${question.options[3]} ${question.correct === 3 ? '✓' : ''}
            </div>
          </div>
        `;

        container.appendChild(questionEl);
      });

      // Add event listeners to buttons
      document.querySelectorAll('.edit-question-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const index = parseInt(btn.getAttribute('data-index'));
          editQuestion(index);
        });
      });

      document.querySelectorAll('.delete-question-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const index = parseInt(btn.getAttribute('data-index'));
          deleteQuestion(index);
        });
      });
    }

    // Reset question form
    function resetQuestionForm() {
      document.getElementById('questionText').value = '';
      document.getElementById('option1').value = '';
      document.getElementById('option2').value = '';
      document.getElementById('option3').value = '';
      document.getElementById('option4').value = '';
      document.querySelector('input[name="correctOption"][value="0"]').checked = true;
      selectedQuestionIndex = null;
      isEditingQuestion = false;
      document.getElementById('questionFormTitle').textContent = 'Add New Question';
      document.getElementById('cancelEditBtn').style.display = 'none';
      document.querySelector('button[type="submit"]').textContent = 'Add Question';
      updateOptionBorders();
    }

    // Edit question
    function editQuestion(index) {
      const question = currentQuestions[index];
      document.getElementById('questionText').value = question.question;
      document.getElementById('option1').value = question.options[0];
      document.getElementById('option2').value = question.options[1];
      document.getElementById('option3').value = question.options[2];
      document.getElementById('option4').value = question.options[3];
      document.querySelector(`input[name="correctOption"][value="${question.correct}"]`).checked = true;
      selectedQuestionIndex = index;
      isEditingQuestion = true;
      document.getElementById('questionFormTitle').textContent = 'Edit Question';
      document.getElementById('cancelEditBtn').style.display = 'inline-block';
      document.querySelector('#questionForm button[type="submit"]').textContent = 'Update Question';
      updateOptionBorders();
    }

    // Handle question form submission
    async function handleQuestionSubmit(e) {
      e.preventDefault();

      if (!user || !authToken) {
        showError('You must be logged in to add questions');
        return;
      }

      const questionText = document.getElementById('questionText').value;
      const option1 = document.getElementById('option1').value;
      const option2 = document.getElementById('option2').value;
      const option3 = document.getElementById('option3').value;
      const option4 = document.getElementById('option4').value;
      const correctOption = parseInt(document.querySelector('input[name="correctOption"]:checked').value);

      if (!questionText || !option1 || !option2 || !option3 || !option4) {
        showError('All fields are required');
        return;
      }

      const options = [option1, option2, option3, option4];

      try {
        if (isEditingQuestion && selectedQuestionIndex !== null) {
          // Update existing question
          const question = currentQuestions[selectedQuestionIndex];

          const updateResponse = await fetch(`${FIREBASE_DATABASE_URL}/trivia_questions/${editingTriviaId}/${question.id}.json?auth=${authToken}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              question: questionText,
              options,
              correct: correctOption
            })
          });

          if (updateResponse.ok) {
            // Update local questions array
            currentQuestions[selectedQuestionIndex] = {
              ...question,
              question: questionText,
              options,
              correct: correctOption
            };

            showSuccess('Question updated successfully!');
            resetQuestionForm();
            renderQuestionsList();
          } else {
            showError('Failed to update question');
          }
        } else {
          // Add new question
          const addResponse = await fetch(`${FIREBASE_DATABASE_URL}/trivia_questions/${editingTriviaId}.json?auth=${authToken}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              question: questionText,
              options,
              correct: correctOption
            })
          });

          const addData = await addResponse.json();

          if (addResponse.ok && addData.name) {
            // Add to local questions array
            currentQuestions.push({
              id: addData.name,
              question: questionText,
              options,
              correct: correctOption
            });

            // Update question count in trivia
            await updateQuestionCount(editingTriviaId, currentQuestions.length);

            document.getElementById('questionCount').textContent = currentQuestions.length;
            showSuccess('Question added successfully!');
            resetQuestionForm();
            renderQuestionsList();
          } else {
            showError('Failed to add question');
          }
        }
      } catch (error) {
        console.error("Question operation error:", error);
        showError('An error occurred. Please try again.');
      }
    }

    // Delete question
    async function deleteQuestion(index) {
      if (!window.confirm('Are you sure you want to delete this question?')) {
        return;
      }

      const question = currentQuestions[index];

      try {
        const deleteResponse = await fetch(`${FIREBASE_DATABASE_URL}/trivia_questions/${editingTriviaId}/${question.id}.json?auth=${authToken}`, {
          method: 'DELETE'
        });

        if (deleteResponse.ok) {
          // Remove from local questions array
          currentQuestions.splice(index, 1);

          // Update question count in trivia
          await updateQuestionCount(editingTriviaId, currentQuestions.length);

          document.getElementById('questionCount').textContent = currentQuestions.length;
          showSuccess('Question deleted successfully!');

          // If editing this question, reset the form
          if (selectedQuestionIndex === index) {
            resetQuestionForm();
          } else if (selectedQuestionIndex !== null && selectedQuestionIndex > index) {
            // Adjust selected index if we deleted a question before it
            selectedQuestionIndex--;
          }

          renderQuestionsList();
        } else {
          showError('Failed to delete question');
        }
      } catch (error) {
        console.error("Delete question error:", error);
        showError('An error occurred. Please try again.');
      }
    }

    // Update question count in trivia
    async function updateQuestionCount(triviaId, count) {
      try {
        const response = await fetch(`${FIREBASE_DATABASE_URL}/trivias/${triviaId}.json?auth=${authToken}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            question_count: count
          })
        });

        if (response.ok) {
          // Update counts in local trivia lists
          if (allTrivias.length > 0) {
            const trivia = allTrivias.find(t => t.id === triviaId);
            if (trivia) {
              trivia.question_count = count;
            }
          }

          if (myTrivias.length > 0) {
            const trivia = myTrivias.find(t => t.id === triviaId);
            if (trivia) {
              trivia.question_count = count;
            }
          }
        }
      } catch (error) {
        console.error("Update question count error:", error);
      }
    }

    // Handle sign out
    function handleSignOut() {
      // Clear authentication data
      localStorage.removeItem('triviaUser');
      localStorage.removeItem('triviaToken');
      // Don't remove profile photo - it can be kept for next login
      //localStorage.removeItem('profilePhotoData');

      user = null;
      userData = null;
      authToken = null;

      // Show success message
      showSuccess('Signed out successfully!');

      // Update UI
      document.getElementById('loggedOut').style.display = 'flex';
      document.getElementById('loggedInNav').style.display = 'none';
      document.getElementById('userAccountDropdown').style.display = 'none';

      // Go back to main content
      showMainContent();

      // Hide edit buttons
      if (selectedTrivia) {
        document.getElementById('editQuestionsBtn').style.display = 'none';
      }
    }

    // Show error message
    function showError(message) {
      const errorMsg = document.getElementById('errorMessage');
      errorMsg.textContent = message;
      errorMsg.style.display = 'block';

      setTimeout(() => {
        errorMsg.style.display = 'none';
      }, 5000);
    }

    // Show success message
    function showSuccess(message) {
      const successMsg = document.getElementById('successMessage');
      successMsg.textContent = message;
      successMsg.style.display = 'block';

      setTimeout(() => {
        successMsg.style.display = 'none';
      }, 3000);
    }

    // Load and display community posts preview on the home page
    async function loadCommunityPostsPreview() {
      const communityPosts = document.getElementById('communityPosts');
      const loadingCommunityPosts = document.getElementById('loadingCommunityPosts');
      const noPostsMessage = document.getElementById('noPostsMessage');

      try {
        // For demo purposes - simulate API call delay
        await new Promise(resolve => setTimeout(resolve, 1000));

        // Mock data - same structure as in community.html
        const posts = [
          {
            id: 'post1',
            title: 'Just beat my high score!',
            content: 'Finally managed to answer 20 questions correctly in a row! This game is so addictive.',
            authorId: 'user1',
            authorName: 'JohnDoe',
            timestamp: Date.now() - 3600000, // 1 hour ago
            likes: 15,
            comments: 3,
            hasImage: false
          },
          {
            id: 'post3',
            title: 'Check out my Triviation setup!',
            content: 'Playing Triviation with friends over the weekend. We had a blast!',
            authorId: 'user3',
            authorName: 'TriviaFan42',
            timestamp: Date.now() - 172800000, // 2 days ago
            likes: 28,
            comments: 5,
            hasImage: true,
            imageUrl: 'https://via.placeholder.com/800x450?text=Game+Night+with+Triviation'
          },
          {
            id: 'post5',
            title: 'New to Triviation - Any tips?',
            content: 'Just downloaded the app yesterday and loving it so far! Any pro tips for beginners?',
            authorId: 'user5',
            authorName: 'NewbieTriviaPlayer',
            timestamp: Date.now() - 345600000, // 4 days ago
            likes: 10,
            comments: 15,
            hasImage: false
          }
        ];

        // Hide loading message
        loadingCommunityPosts.style.display = 'none';

        if (posts.length > 0) {
          // Create post preview cards
          communityPosts.innerHTML = '';

          posts.forEach(post => {
            const postCard = document.createElement('div');
            postCard.className = 'bg-medium-blue rounded-lg overflow-hidden shadow-md hover:shadow-lg transition-shadow';

            // Format the timestamp
            const timeAgo = formatTimeAgo(post.timestamp);

            // Truncate content for preview
            const shortContent = post.content.length > 80
              ? post.content.substring(0, 80) + '...'
              : post.content;

            postCard.innerHTML = `
              <div class="p-4">
                <div class="flex items-center mb-2">
                  <div class="w-8 h-8 rounded-full bg-dark-blue text-cream flex items-center justify-center font-bold">
                    ${post.authorName.charAt(0).toUpperCase()}
                  </div>
                  <div class="ml-2">
                    <span class="text-cream text-sm">${post.authorName}</span>
                    <span class="text-light-blue text-xs ml-2">${timeAgo}</span>
                  </div>
                </div>

                <h3 class="text-lg text-cream font-bold mb-1">${post.title}</h3>
                <p class="text-cream text-sm mb-2">${shortContent}</p>

                ${post.hasImage ? `
                  <div class="h-32 mb-2 rounded overflow-hidden">
                    <img src="${post.imageUrl}" alt="Post image" class="w-full h-full object-cover">
                  </div>
                ` : ''}

                <div class="flex justify-between text-light-blue text-sm">
                  <span>${post.likes} likes</span>
                  <span>${post.comments} comments</span>
                </div>
              </div>
            `;

            // Make the entire card clickable to go to the community page
            postCard.addEventListener('click', () => {
              window.location.href = 'community.html?post=' + post.id;
            });
            postCard.style.cursor = 'pointer';

            communityPosts.appendChild(postCard);
          });

          communityPosts.style.display = 'grid';
          noPostsMessage.style.display = 'none';
        } else {
          communityPosts.style.display = 'none';
          noPostsMessage.style.display = 'block';
        }
      } catch (error) {
        console.error('Error loading community posts:', error);
        loadingCommunityPosts.style.display = 'none';
        communityPosts.style.display = 'none';
        noPostsMessage.style.display = 'block';
        noPostsMessage.innerHTML = '<p class="text-red">Error loading community posts</p>';
      }
    }

    // Format timestamp to "time ago" format
    function formatTimeAgo(timestamp) {
      const now = Date.now();
      const diff = now - timestamp;

      // Convert to seconds
      const seconds = Math.floor(diff / 1000);

      if (seconds < 60) {
        return 'just now';
      }

      // Convert to minutes
      const minutes = Math.floor(seconds / 60);

      if (minutes < 60) {
        return `${minutes}m ago`;
      }

      // Convert to hours
      const hours = Math.floor(minutes / 60);

      if (hours < 24) {
        return `${hours}h ago`;
      }

      // Convert to days
      const days = Math.floor(hours / 24);

      if (days < 30) {
        return `${days}d ago`;
      }

      // Convert to months
      const months = Math.floor(days / 30);

      if (months < 12) {
        return `${months}mo ago`;
      }

      // Convert to years
      const years = Math.floor(months / 12);

      return `${years}y ago`;
    }
  </script>
</body>
</html>
