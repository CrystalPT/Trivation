<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trivia Master</title>

  <!-- Tailwind CSS for styling -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    /* Define color variables */
    :root {
      --dark-bg: #0d1321;
      --dark-blue: #1d2d44;
      --medium-blue: #3e5c76;
      --light-blue: #748cab;
      --cream: #f0ebd8;
      --white: #ffffff;
      --black: #000000;
      --gray: #c8c8c8;
      --red: #ff5050;
      --green: #50c878;
    }

    /* Apply colors with CSS variables */
    .bg-dark-bg { background-color: var(--dark-bg); }
    .bg-dark-blue { background-color: var(--dark-blue); }
    .bg-medium-blue { background-color: var(--medium-blue); }
    .bg-light-blue { background-color: var(--light-blue); }
    .bg-cream { background-color: var(--cream); }
    .bg-red { background-color: var(--red); }
    .bg-green { background-color: var(--green); }

    .text-cream { color: var(--cream); }
    .text-light-blue { color: var(--light-blue); }
    .text-dark-blue { color: var(--dark-blue); }
    .text-white { color: var(--white); }
    .text-dark-bg { color: var(--dark-bg); }

    .border-light-blue { border-color: var(--light-blue); }
    .border-medium-blue { border-color: var(--medium-blue); }
    .border-gray { border-color: var(--gray); }
    .border-green { border-color: var(--green); }
  </style>
</head>
<body class="bg-dark-bg">
  <div class="min-h-screen p-6">
    <!-- Header -->
    <header class="mb-8 p-4 rounded-lg bg-dark-blue">
      <div class="flex flex-col md:flex-row justify-between items-center">
        <a href="index.html" class="text-4xl font-bold mb-4 md:mb-0 text-cream no-underline">
          TRIVIA MASTER
        </a>

        <!-- Navigation buttons -->
        <div class="flex flex-wrap gap-3 mb-4 md:mb-0">
          <a
            href="https://github.com/CrystalPT/Trivation/releases"
            target="_blank"
            rel="noopener noreferrer"
            class="px-4 py-2 rounded-lg text-center bg-medium-blue text-cream no-underline"
          >
            Downloads
          </a>

          <!-- These links will only be shown when logged in -->
          <div id="loggedInNav" style="display: none;">
            <button
              id="navCreateTrivia"
              class="px-4 py-2 rounded-lg bg-medium-blue text-cream">
              Create Trivia
            </button>
            <button
              id="navMyTrivias"
              class="px-4 py-2 rounded-lg bg-medium-blue text-cream">
              My Trivias
            </button>
          </div>
        </div>

        <!-- User controls -->
        <div>
          <div id="loggedOut" class="flex gap-2">
            <a href="login.html" class="px-4 py-2 rounded-lg bg-medium-blue text-cream no-underline">
              Sign In
            </a>
            <a href="login.html?page=signup" class="px-4 py-2 rounded-lg bg-green text-white no-underline">
              Sign Up
            </a>
          </div>

          <div id="loggedIn" class="flex items-center gap-4 flex-wrap justify-center" style="display: none;">
            <p id="userDisplayName" class="text-lg text-cream"></p>
            <a href="account.html" class="px-4 py-2 rounded-lg bg-medium-blue text-cream no-underline">
              Account Settings
            </a>
            <button
              id="signOutBtn"
              class="px-4 py-2 rounded-lg bg-medium-blue text-cream"
            >
              Sign Out
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Messages -->
    <div id="errorMessage" class="mb-4 p-3 rounded-lg bg-red text-white" style="display: none;"></div>
    <div id="successMessage" class="mb-4 p-3 rounded-lg bg-green text-white" style="display: none;"></div>

    <!-- Main content (Leaderboards) -->
    <div id="mainContent" class="flex flex-col lg:flex-row gap-8">
      <!-- Trivia Leaderboards -->
      <div class="lg:w-2/3 rounded-lg p-6 bg-dark-blue">
        <h2 class="text-2xl mb-4 text-cream">Trivia Leaderboards</h2>

        <!-- Trivia Selector -->
        <div id="triviaSelector" class="mb-6">
          <p id="loadingText" class="text-light-blue">Loading trivias...</p>
          <p id="noTriviasText" class="text-light-blue" style="display: none;">No trivias available</p>
          <select
            id="triviaSelect"
            class="w-full p-3 rounded-lg border border-light-blue bg-dark-bg text-cream"
            style="display: none;"
          >
          </select>
        </div>

        <!-- Selected Trivia Info -->
        <div id="selectedTriviaInfo" class="mb-6 p-4 rounded-lg bg-medium-blue" style="display: none;">
          <h3 id="triviaTitle" class="text-xl font-bold mb-1 text-cream"></h3>
          <p id="triviaCreator" class="text-light-blue mb-2"></p>
          <p id="triviaDescription" class="text-cream mb-3"></p>

          <!-- Action buttons -->
          <div class="flex flex-wrap gap-3">
            <a
              href="https://github.com/CrystalPT/Trivation/releases"
              target="_blank"
              rel="noopener noreferrer"
              class="px-4 py-2 rounded-lg inline-block bg-light-blue text-dark-blue no-underline"
            >
              Download to Play
            </a>
            <button
              id="editQuestionsBtn"
              class="px-4 py-2 rounded-lg bg-cream text-dark-blue"
              style="display: none;"
            >
              Edit Questions
            </button>
          </div>
        </div>

        <!-- Leaderboard -->
        <div id="leaderboardContainer"></div>
      </div>

      <!-- Global Leaderboard -->
      <div class="lg:w-1/3 rounded-lg p-6 bg-dark-blue">
        <h2 class="text-2xl mb-4 text-cream">Global Leaderboard</h2>
        <div id="globalLeaderboardContainer"></div>
      </div>
    </div>

    <!-- Create Trivia Form -->
    <div id="createTriviaContent" class="mb-8 p-6 rounded-lg bg-dark-blue" style="display: none;">
      <h2 class="text-2xl mb-4 text-cream">Create New Trivia</h2>

      <div id="createTriviaStep1">
        <form id="createTriviaForm">
          <div class="mb-4">
            <label class="block mb-2 text-light-blue">Trivia Title</label>
            <input
              type="text"
              id="triviaTitle"
              class="w-full p-2 rounded-lg border bg-dark-bg text-cream border-light-blue"
              required
            />
          </div>
          <div class="mb-4">
            <label class="block mb-2 text-light-blue">Description</label>
            <textarea
              id="triviaDescription"
              class="w-full p-2 rounded-lg border bg-dark-bg text-cream border-light-blue"
              style="min-height: 100px;"
            ></textarea>
          </div>
          <div class="flex gap-3">
            <button
              type="submit"
              class="px-4 py-2 rounded-lg bg-medium-blue text-cream"
            >
              Create Trivia
            </button>
            <button
              type="button"
              id="cancelCreateTriviaBtn"
              class="px-4 py-2 rounded-lg bg-dark-blue text-cream border border-light-blue"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>

      <div id="createTriviaStep2" style="display: none;">
        <p class="mb-4 text-cream">
          Your trivia "<span id="createdTriviaTitle"></span>" has been created successfully!
        </p>
        <div class="flex flex-wrap gap-3">
          <button
            id="addQuestionsNowBtn"
            class="px-4 py-2 rounded-lg bg-green text-white"
          >
            Add Questions Now
          </button>
          <button
            id="createAnotherTriviaBtn"
            class="px-4 py-2 rounded-lg bg-medium-blue text-cream"
          >
            Create Another Trivia
          </button>
          <button
            id="backToLeaderboardsBtn"
            class="px-4 py-2 rounded-lg bg-dark-blue text-cream border border-light-blue"
          >
            Return to Leaderboards
          </button>
        </div>
      </div>
    </div>

    <!-- My Trivias Section -->
    <div id="myTriviasContent" class="mb-8 p-6 rounded-lg bg-dark-blue" style="display: none;">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl text-cream">My Trivias</h2>
        <div class="flex gap-3">
          <button
            id="myTriviasCreateBtn"
            class="px-4 py-2 rounded-lg bg-green text-white"
          >
            Create New Trivia
          </button>
          <button
            id="myTriviasBackBtn"
            class="px-4 py-2 rounded-lg bg-medium-blue text-cream"
          >
            Back to Leaderboards
          </button>
        </div>
      </div>

      <div id="myTriviasList" class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <p id="loadingMyTrivias" class="text-cream">Loading your trivias...</p>
        <div id="noTriviasYet" style="display: none;" class="text-center p-6 col-span-2">
          <p class="text-xl mb-4 text-cream">You haven't created any trivias yet.</p>
          <button
            id="createFirstTriviaBtn"
            class="px-4 py-2 rounded-lg bg-green text-white"
          >
            Create Your First Trivia
          </button>
        </div>
      </div>
    </div>

    <!-- Question Editor -->
    <div id="questionEditorContent" class="mb-8 p-6 rounded-lg bg-dark-blue" style="display: none;">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl text-cream">
          Questions for: <span id="editingTriviaTitle"></span>
        </h2>
        <div class="flex gap-2">
          <button
            id="backToMyTriviasBtn"
            class="px-4 py-2 rounded-lg bg-medium-blue text-cream"
          >
            Back to My Trivias
          </button>
          <button
            id="doneEditingBtn"
            class="px-4 py-2 rounded-lg bg-dark-blue text-cream border border-light-blue"
          >
            Done
          </button>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Question form -->
        <div class="mb-6">
          <h3 id="questionFormTitle" class="text-xl mb-3 text-light-blue">
            Add New Question
          </h3>
          <form id="questionForm">
            <div class="mb-4">
              <label class="block mb-2 text-light-blue">Question</label>
              <input
                type="text"
                id="questionText"
                class="w-full p-2 rounded-lg border bg-dark-bg text-cream border-light-blue"
                required
              />
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <label class="block mb-2 text-light-blue">
                  Option 1
                  <input
                    type="radio"
                    name="correctOption"
                    value="0"
                    class="ml-2"
                    checked
                  />
                  <span class="ml-1 text-cream">Correct</span>
                </label>
                <input
                  type="text"
                  id="option1"
                  class="w-full p-2 rounded-lg border bg-dark-bg text-cream border-option1"
                  required
                />
              </div>

              <div>
                <label class="block mb-2 text-light-blue">
                  Option 2
                  <input
                    type="radio"
                    name="correctOption"
                    value="1"
                    class="ml-2"
                  />
                  <span class="ml-1 text-cream">Correct</span>
                </label>
                <input
                  type="text"
                  id="option2"
                  class="w-full p-2 rounded-lg border bg-dark-bg text-cream border-light-blue"
                  required
                />
              </div>

              <div>
                <label class="block mb-2 text-light-blue">
                  Option 3
                  <input
                    type="radio"
                    name="correctOption"
                    value="2"
                    class="ml-2"
                  />
                  <span class="ml-1 text-cream">Correct</span>
                </label>
                <input
                  type="text"
                  id="option3"
                  class="w-full p-2 rounded-lg border bg-dark-bg text-cream border-light-blue"
                  required
                />
              </div>

              <div>
                <label class="block mb-2 text-light-blue">
                  Option 4
                  <input
                    type="radio"
                    name="correctOption"
                    value="3"
                    class="ml-2"
                  />
                  <span class="ml-1 text-cream">Correct</span>
                </label>
                <input
                  type="text"
                  id="option4"
                  class="w-full p-2 rounded-lg border bg-dark-bg text-cream border-light-blue"
                  required
                />
              </div>
            </div>

            <div class="flex gap-3">
              <button
                type="submit"
                class="px-4 py-2 rounded-lg bg-medium-blue text-cream"
              >
                Add Question
              </button>
              <button
                type="button"
                id="cancelEditBtn"
                class="px-4 py-2 rounded-lg bg-dark-blue text-cream border border-light-blue"
                style="display: none;"
              >
                Cancel Edit
              </button>
            </div>
          </form>
        </div>

        <!-- Questions list -->
        <div>
          <h3 class="text-xl mb-3 text-light-blue">
            Questions (<span id="questionCount">0</span>)
          </h3>
          <div id="questionsListEmpty" class="text-cream">No questions yet. Add your first question!</div>
          <div id="questionsList" class="max-h-[500px] overflow-y-auto pr-2"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Firebase configuration
    const FIREBASE_API_KEY = "AIzaSyDIgbZvfYb2kxazfrZcrddAVEZ7tVdWvhA";
    const FIREBASE_DATABASE_URL = "https://trivia-20b98-default-rtdb.europe-west1.firebasedatabase.app";

    // Global state
    let user = null;
    let userData = null;
    let authToken = null;
    let allTrivias = [];
    let selectedTrivia = null;
    let myTrivias = [];
    let currentQuestions = [];
    let editingTriviaId = null;
    let isEditingQuestion = false;
    let selectedQuestionIndex = null;
    let createdTriviaId = null;

    // Initialization on page load
    document.addEventListener('DOMContentLoaded', () => {
      // Check URL for page parameter
      const urlParams = new URLSearchParams(window.location.search);
      const page = urlParams.get('page');
      const id = urlParams.get('id');

      // Check authentication state first
      checkAuthState().then(() => {
        // Then determine which page to show
        if (page === 'create-trivia' && user) {
          showCreateTriviaContent();
        } else if (page === 'my-trivias' && user) {
          showMyTriviasContent();
        } else if (page === 'edit-questions' && id && user) {
          editingTriviaId = id;
          showQuestionEditorContent(id);
        } else {
          showMainContent();
        }
      });

      // Add event listeners for navigation
      document.getElementById('navCreateTrivia').addEventListener('click', showCreateTriviaContent);
      document.getElementById('navMyTrivias').addEventListener('click', showMyTriviasContent);
      document.getElementById('signOutBtn').addEventListener('click', handleSignOut);

      // Create trivia form listeners
      document.getElementById('createTriviaForm').addEventListener('submit', handleCreateTrivia);
      document.getElementById('cancelCreateTriviaBtn').addEventListener('click', showMainContent);
      document.getElementById('createAnotherTriviaBtn').addEventListener('click', resetCreateTriviaForm);
      document.getElementById('backToLeaderboardsBtn').addEventListener('click', showMainContent);
      document.getElementById('addQuestionsNowBtn').addEventListener('click', () => {
        if (createdTriviaId) {
          editingTriviaId = createdTriviaId;
          showQuestionEditorContent(createdTriviaId);
        }
      });

      // My trivias listeners
      document.getElementById('myTriviasCreateBtn').addEventListener('click', showCreateTriviaContent);
      document.getElementById('myTriviasBackBtn').addEventListener('click', showMainContent);
      document.getElementById('createFirstTriviaBtn').addEventListener('click', showCreateTriviaContent);

      // Question editor listeners
      document.getElementById('backToMyTriviasBtn').addEventListener('click', showMyTriviasContent);
      document.getElementById('doneEditingBtn').addEventListener('click', showMainContent);
      document.getElementById('questionForm').addEventListener('submit', handleQuestionSubmit);
      document.getElementById('cancelEditBtn').addEventListener('click', resetQuestionForm);

      // Setup option input border colors
      setupOptionInputs();
    });

    // Setup option input borders
    function setupOptionInputs() {
      // Get all radio buttons for correct option
      const correctOptions = document.getElementsByName('correctOption');

      // Add event listener to each radio button
      correctOptions.forEach(option => {
        option.addEventListener('change', updateOptionBorders);
      });

      // Initial setup
      updateOptionBorders();
    }

    // Update option borders based on selected correct option
    function updateOptionBorders() {
      const correctOptionValue = document.querySelector('input[name="correctOption"]:checked').value;

      // Reset all borders
      for (let i = 1; i <= 4; i++) {
        const option = document.getElementById(`option${i}`);
        option.style.borderColor = 'var(--light-blue)';
      }

      // Set green border for correct option
      const correctOption = document.getElementById(`option${parseInt(correctOptionValue) + 1}`);
      correctOption.style.borderColor = 'var(--green)';
    }

    // Check authentication state
    async function checkAuthState() {
      const savedUser = localStorage.getItem('triviaUser');
      const savedToken = localStorage.getItem('triviaToken');

      if (savedUser && savedToken) {
        user = JSON.parse(savedUser);
        authToken = savedToken;

        // Show logged in UI
        document.getElementById('loggedIn').style.display = 'flex';
        document.getElementById('loggedOut').style.display = 'none';
        document.getElementById('loggedInNav').style.display = 'block';

        // Set user name
        document.getElementById('userDisplayName').textContent = user.displayName || user.email;

        // Load user data
        await fetchUserData(user.localId, savedToken);
        return true;
      } else {
        // Show logged out UI
        document.getElementById('loggedIn').style.display = 'none';
        document.getElementById('loggedOut').style.display = 'flex';
        document.getElementById('loggedInNav').style.display = 'none';
        return false;
      }
    }

    // Fetch user data from Firebase
    async function fetchUserData(userId, token) {
      try {
        const response = await fetch(`${FIREBASE_DATABASE_URL}/users/${userId}.json?auth=${token}`);
        if (response.ok) {
          const data = await response.json();
          if (data) {
            userData = data;

            // If username is available, update display name
            if (data.username) {
              document.getElementById('userDisplayName').textContent = data.username;

              // Update user object
              user.displayName = data.username;
              localStorage.setItem('triviaUser', JSON.stringify(user));
            }
          }
        }
      } catch (error) {
        console.error("Error fetching user data:", error);
      }
    }

    // Show main content (leaderboards)
    function showMainContent() {
      // Hide other content
      document.getElementById('createTriviaContent').style.display = 'none';
      document.getElementById('myTriviasContent').style.display = 'none';
      document.getElementById('questionEditorContent').style.display = 'none';

      // Show main content
      document.getElementById('mainContent').style.display = 'flex';

      // Load trivias if not already loaded
      if (allTrivias.length === 0) {
        loadTrivias();
        loadGlobalLeaderboard();
      }

      // Update URL without reloading
      history.pushState(null, '', 'index.html');

      // Update active nav button
      updateNavButtons();
    }

    // Show create trivia content
    function showCreateTriviaContent() {
      if (!user) {
        window.location.href = 'login.html?redirect=index.html?page=create-trivia';
        return;
      }

      // Hide other content
      document.getElementById('mainContent').style.display = 'none';
      document.getElementById('myTriviasContent').style.display = 'none';
      document.getElementById('questionEditorContent').style.display = 'none';

      // Show create trivia form
      document.getElementById('createTriviaContent').style.display = 'block';
      document.getElementById('createTriviaStep1').style.display = 'block';
      document.getElementById('createTriviaStep2').style.display = 'none';

      // Update URL without reloading
      history.pushState(null, '', 'index.html?page=create-trivia');

      // Update active nav button
      updateNavButtons('create');
    }

    // Show my trivias content
    function showMyTriviasContent() {
      if (!user) {
        window.location.href = 'login.html?redirect=index.html?page=my-trivias';
        return;
      }

      // Hide other content
      document.getElementById('mainContent').style.display = 'none';
      document.getElementById('createTriviaContent').style.display = 'none';
      document.getElementById('questionEditorContent').style.display = 'none';

      // Show my trivias content
      document.getElementById('myTriviasContent').style.display = 'block';

      // Load user's trivias
      loadMyTrivias();

      // Update URL without reloading
      history.pushState(null, '', 'index.html?page=my-trivias');

      // Update active nav button
      updateNavButtons('my-trivias');
    }

    // Show question editor content
    function showQuestionEditorContent(triviaId) {
      if (!user) {
        window.location.href = 'login.html?redirect=index.html?page=edit-questions&id=' + triviaId;
        return;
      }

      // Hide other content
      document.getElementById('mainContent').style.display = 'none';
      document.getElementById('createTriviaContent').style.display = 'none';
      document.getElementById('myTriviasContent').style.display = 'none';

      // Show question editor content
      document.getElementById('questionEditorContent').style.display = 'block';

      // Load trivia details and questions
      loadTriviaForEditing(triviaId);

      // Reset the question form
      resetQuestionForm();

      // Update URL without reloading
      history.pushState(null, '', 'index.html?page=edit-questions&id=' + triviaId);
    }

    // Update navigation buttons
    function updateNavButtons(active = null) {
      const createBtn = document.getElementById('navCreateTrivia');
      const myTriviasBtn = document.getElementById('navMyTrivias');

      // Reset both buttons
      createBtn.className = 'px-4 py-2 rounded-lg bg-medium-blue text-cream';
      myTriviasBtn.className = 'px-4 py-2 rounded-lg bg-medium-blue text-cream';

      // Set active button
      if (active === 'create') {
        createBtn.className = 'px-4 py-2 rounded-lg bg-light-blue text-dark-blue';
      } else if (active === 'my-trivias') {
        myTriviasBtn.className = 'px-4 py-2 rounded-lg bg-light-blue text-dark-blue';
      }
    }

    // Load all trivias for main page
    async function loadTrivias() {
      try {
        const response = await fetch(`${FIREBASE_DATABASE_URL}/trivias.json`);
        if (response.ok) {
          const data = await response.json();

          document.getElementById('loadingText').style.display = 'none';

          if (data) {
            // Convert to array
            allTrivias = Object.keys(data).map(key => ({
              id: key,
              ...data[key]
            }));

            // Sort by play count (most played first)
            allTrivias.sort((a, b) => (b.play_count || 0) - (a.play_count || 0));

            // Populate dropdown
            const selectElement = document.getElementById('triviaSelect');
            selectElement.innerHTML = '';

            allTrivias.forEach(trivia => {
              const option = document.createElement('option');
              option.value = trivia.id;
              option.textContent = `${trivia.title} (${trivia.question_count || 0} questions, ${trivia.play_count || 0} plays)`;
              selectElement.appendChild(option);
            });

            selectElement.style.display = 'block';

            // Add change event listener
            selectElement.addEventListener('change', (e) => {
              const selected = allTrivias.find(t => t.id === e.target.value);
              if (selected) {
                displayTriviaInfo(selected);
                fetchLeaderboard(selected.id);
              }
            });

            // Select first trivia by default
            if (allTrivias.length > 0) {
              selectElement.value = allTrivias[0].id;
              selectedTrivia = allTrivias[0];
              displayTriviaInfo(allTrivias[0]);
              fetchLeaderboard(allTrivias[0].id);
            }
          } else {
            document.getElementById('noTriviasText').style.display = 'block';
          }
        }
      } catch (error) {
        console.error("Error loading trivias:", error);
        document.getElementById('loadingText').style.display = 'none';
        document.getElementById('noTriviasText').style.display = 'block';
      }
    }

    // Display trivia info
    function displayTriviaInfo(trivia) {
      selectedTrivia = trivia;

      document.getElementById('triviaTitle').textContent = trivia.title;
      document.getElementById('triviaCreator').textContent = `Created by: ${trivia.created_by}`;

      const descElement = document.getElementById('triviaDescription');
      if (trivia.description) {
        descElement.textContent = trivia.description;
        descElement.style.display = 'block';
      } else {
        descElement.style.display = 'none';
      }

      // Show edit button if user is the creator
      const editBtn = document.getElementById('editQuestionsBtn');

      if (user && user.localId === trivia.created_by_id) {
        editBtn.style.display = 'inline-block';
        editBtn.onclick = () => showQuestionEditorContent(trivia.id);
      } else {
        editBtn.style.display = 'none';
      }

      document.getElementById('selectedTriviaInfo').style.display = 'block';
    }

    // Fetch trivia leaderboard
    async function fetchLeaderboard(triviaId) {
      try {
        const response = await fetch(`${FIREBASE_DATABASE_URL}/leaderboards/${triviaId}.json`);
        const container = document.getElementById('leaderboardContainer');

        if (response.ok) {
          const data = await response.json();

          if (data) {
            // Convert to array and sort by score
            const leaderboardArray = Object.keys(data).map(key => ({
              userId: key,
              ...data[key]
            }));

            leaderboardArray.sort((a, b) => b.score - a.score);

            // Render leaderboard
            container.innerHTML = renderLeaderboardHTML(leaderboardArray);
          } else {
            container.innerHTML = '<div class="text-center p-4"><p class="text-lg text-cream">No scores yet</p></div>';
          }
        } else {
          container.innerHTML = '<div class="text-center p-4"><p class="text-lg text-cream">Failed to load leaderboard</p></div>';
        }
      } catch (error) {
        console.error("Error fetching leaderboard:", error);
        document.getElementById('leaderboardContainer').innerHTML =
          '<div class="text-center p-4"><p class="text-lg text-cream">Error loading leaderboard</p></div>';
      }
    }

    // Load global leaderboard
    async function loadGlobalLeaderboard() {
      try {
        const response = await fetch(`${FIREBASE_DATABASE_URL}/users.json`);
        const container = document.getElementById('globalLeaderboardContainer');

        if (response.ok) {
          const data = await response.json();

          if (data) {
            // Convert to array and extract needed data
            const usersArray = Object.keys(data).map(key => ({
              userId: key,
              username: data[key].username,
              highScore: data[key].stats?.high_score || 0,
              gamesPlayed: data[key].stats?.games_played || 0
            }));

            // Sort by high score
            usersArray.sort((a, b) => b.highScore - a.highScore);

            // Take top 10
            const top10 = usersArray.slice(0, 10);

            // Render global leaderboard
            container.innerHTML = renderLeaderboardHTML(top10, true);
          } else {
            container.innerHTML = '<div class="text-center p-4"><p class="text-lg text-cream">No users yet</p></div>';
          }
        } else {
          container.innerHTML = '<div class="text-center p-4"><p class="text-lg text-cream">Failed to load leaderboard</p></div>';
        }
      } catch (error) {
        console.error("Error fetching global leaderboard:", error);
        document.getElementById('globalLeaderboardContainer').innerHTML =
          '<div class="text-center p-4"><p class="text-lg text-cream">Error loading leaderboard</p></div>';
      }
    }

    // Render leaderboard HTML
    function renderLeaderboardHTML(entries, global = false) {
      if (entries.length === 0) {
        return '<div class="text-center p-4"><p class="text-lg text-cream">No scores yet</p></div>';
      }

      let html = `
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead>
              <tr style="border-bottom: 1px solid var(--light-blue)">
                <th class="px-4 py-2 text-left text-light-blue">Rank</th>
                <th class="px-4 py-2 text-left text-light-blue">Username</th>
                <th class="px-4 py-2 text-right text-light-blue">
                  ${global ? 'High Score' : 'Score'}
                </th>
                ${global ? '<th class="px-4 py-2 text-right text-light-blue">Games</th>' : ''}
              </tr>
            </thead>
            <tbody>
      `;

      entries.forEach((entry, index) => {
        const bgColor = index % 2 === 0 ? 'var(--dark-blue)' : 'rgba(29, 45, 68, 0.5)';

        html += `
          <tr style="border-bottom: 1px solid var(--medium-blue); background-color: ${bgColor}">
            <td class="px-4 py-3">
              <div class="flex items-center justify-center w-8 h-8 rounded-full font-bold bg-light-blue text-dark-blue">
                ${index + 1}
              </div>
            </td>
            <td class="px-4 py-3 text-cream">${entry.username}</td>
            <td class="px-4 py-3 text-right text-cream">
              ${global ? entry.highScore : entry.score}
            </td>
            ${global ? `<td class="px-4 py-3 text-right text-cream">${entry.gamesPlayed}</td>` : ''}
          </tr>
        `;
      });

      html += `
            </tbody>
          </table>
        </div>
      `;

      return html;
    }

    // Handle create trivia form submission
    async function handleCreateTrivia(e) {
      e.preventDefault();

      const title = document.getElementById('triviaTitle').value;
      const description = document.getElementById('triviaDescription').value;

      if (!user || !authToken) {
        showError('You must be logged in to create a trivia');
        return;
      }

      if (!title) {
        showError('Title is required');
        return;
      }

      try {
        // Create the trivia in Firebase
        const createResponse = await fetch(`${FIREBASE_DATABASE_URL}/trivias.json?auth=${authToken}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            title: title,
            description: description,
            created_by: userData.username || user.email,
            created_by_id: user.localId,
            created_at: Date.now(),
            question_count: 0,
            play_count: 0
          })
        });

        const createData = await createResponse.json();

        if (createResponse.ok && createData.name) {
          createdTriviaId = createData.name;
          document.getElementById('createdTriviaTitle').textContent = title;
          document.getElementById('createTriviaStep1').style.display = 'none';
          document.getElementById('createTriviaStep2').style.display = 'block';
          showSuccess('Trivia created successfully!');
        } else {
          showError('Failed to create trivia');
        }
      } catch (error) {
        console.error("Create trivia error:", error);
        showError('An error occurred. Please try again.');
      }
    }

    // Reset create trivia form
    function resetCreateTriviaForm() {
      document.getElementById('triviaTitle').value = '';
      document.getElementById('triviaDescription').value = '';
      document.getElementById('createTriviaStep1').style.display = 'block';
      document.getElementById('createTriviaStep2').style.display = 'none';
    }

    // Load user's trivias
    async function loadMyTrivias() {
      if (!user) return;

      try {
        document.getElementById('loadingMyTrivias').style.display = 'block';
        document.getElementById('noTriviasYet').style.display = 'none';
        document.getElementById('myTriviasList').innerHTML = '<p id="loadingMyTrivias" class="text-cream">Loading your trivias...</p>';

        const response = await fetch(`${FIREBASE_DATABASE_URL}/trivias.json`);
        if (response.ok) {
          const data = await response.json();

          document.getElementById('loadingMyTrivias').style.display = 'none';

          if (data) {
            const triviasList = Object.keys(data)
              .filter(key => data[key].created_by_id === user.localId)
              .map(key => ({
                id: key,
                ...data[key]
              }));

            // Sort by most recently created
            triviasList.sort((a, b) => (b.created_at || 0) - (a.created_at || 0));

            myTrivias = triviasList;

            if (triviasList.length === 0) {
              document.getElementById('noTriviasYet').style.display = 'block';
            } else {
              renderMyTrivias(triviasList);
            }
          } else {
            document.getElementById('noTriviasYet').style.display = 'block';
          }
        }
      } catch (error) {
        console.error("Error fetching user's trivias:", error);
        document.getElementById('loadingMyTrivias').style.display = 'none';
        document.getElementById('myTriviasList').innerHTML = '<p class="text-cream">Error loading your trivias</p>';
      }
    }

    // Render user's trivias
    function renderMyTrivias(trivias) {
      const container = document.getElementById('myTriviasList');
      container.innerHTML = '';

      trivias.forEach(trivia => {
        const triviaEl = document.createElement('div');
        triviaEl.className = 'p-4 rounded-lg bg-medium-blue';
        triviaEl.innerHTML = `
          <h3 class="text-xl font-bold mb-1 text-cream">
            ${trivia.title}
          </h3>
          ${trivia.description ? `<p class="mb-2 text-light-blue">${trivia.description}</p>` : ''}
          <div class="flex justify-between items-center">
            <div class="text-cream">
              <span class="mr-4">Questions: ${trivia.question_count || 0}</span>
              <span>Plays: ${trivia.play_count || 0}</span>
            </div>
            <div class="flex gap-2">
              <button
                class="px-3 py-1 rounded-lg bg-light-blue text-dark-blue edit-questions-btn"
                data-trivia-id="${trivia.id}"
                data-trivia-title="${trivia.title}"
              >
                Edit Questions
              </button>
            </div>
          </div>
        `;

        container.appendChild(triviaEl);
      });

      // Add event listeners to edit buttons
      document.querySelectorAll('.edit-questions-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const triviaId = btn.getAttribute('data-trivia-id');
          showQuestionEditorContent(triviaId);
        });
      });
    }

    // Load trivia for editing
    async function loadTriviaForEditing(triviaId) {
      try {
        // Get trivia details
        const triviaResponse = await fetch(`${FIREBASE_DATABASE_URL}/trivias/${triviaId}.json`);
        if (triviaResponse.ok) {
          const triviaData = await triviaResponse.json();
          if (triviaData) {
            document.getElementById('editingTriviaTitle').textContent = triviaData.title;

            // Check if user is the creator
            if (!user || user.localId !== triviaData.created_by_id) {
              showError("You don't have permission to edit this trivia");
              showMainContent();
              return;
            }
          }
        }

        // Get questions
        await fetchQuestionsForTrivia(triviaId);
      } catch (error) {
        console.error("Error loading trivia for editing:", error);
        showError("Error loading trivia details");
      }
    }

    // Fetch questions for a trivia
    async function fetchQuestionsForTrivia(triviaId) {
      try {
        const response = await fetch(`${FIREBASE_DATABASE_URL}/trivia_questions/${triviaId}.json`);
        if (response.ok) {
          const data = await response.json();
          if (data) {
            // Convert to array
            currentQuestions = Object.keys(data).map(key => ({
              id: key,
              ...data[key]
            }));

            // Update question count
            document.getElementById('questionCount').textContent = currentQuestions.length;

            // Display questions
            renderQuestionsList();

            return currentQuestions;
          } else {
            currentQuestions = [];
            document.getElementById('questionCount').textContent = '0';
            document.getElementById('questionsListEmpty').style.display = 'block';
            document.getElementById('questionsList').innerHTML = '';
            return [];
          }
        }
      } catch (error) {
        console.error("Error fetching questions:", error);
        currentQuestions = [];
        document.getElementById('questionCount').textContent = '0';
        document.getElementById('questionsListEmpty').style.display = 'block';
        document.getElementById('questionsList').innerHTML = '';
        return [];
      }
    }

    // Render questions list
    function renderQuestionsList() {
      const container = document.getElementById('questionsList');
      container.innerHTML = '';

      if (currentQuestions.length === 0) {
        document.getElementById('questionsListEmpty').style.display = 'block';
        return;
      }

      document.getElementById('questionsListEmpty').style.display = 'none';

      currentQuestions.forEach((question, index) => {
        const questionEl = document.createElement('div');
        questionEl.className = 'mb-3 p-3 rounded-lg bg-medium-blue';

        questionEl.innerHTML = `
          <div class="flex justify-between">
            <div class="font-bold text-cream">
              Q${index + 1}: ${question.question}
            </div>
            <div class="flex gap-2">
              <button
                class="px-2 py-1 rounded-lg text-sm bg-light-blue text-dark-blue edit-question-btn"
                data-index="${index}"
              >
                Edit
              </button>
              <button
                class="px-2 py-1 rounded-lg text-sm bg-red text-white delete-question-btn"
                data-index="${index}"
              >
                Delete
              </button>
            </div>
          </div>
          <div class="mt-2">
            <div class="${question.correct === 0 ? 'text-green' : 'text-cream'}">
              1. ${question.options[0]} ${question.correct === 0 ? '✓' : ''}
            </div>
            <div class="${question.correct === 1 ? 'text-green' : 'text-cream'}">
              2. ${question.options[1]} ${question.correct === 1 ? '✓' : ''}
            </div>
            <div class="${question.correct === 2 ? 'text-green' : 'text-cream'}">
              3. ${question.options[2]} ${question.correct === 2 ? '✓' : ''}
            </div>
            <div class="${question.correct === 3 ? 'text-green' : 'text-cream'}">
              4. ${question.options[3]} ${question.correct === 3 ? '✓' : ''}
            </div>
          </div>
        `;

        container.appendChild(questionEl);
      });

      // Add event listeners to buttons
      document.querySelectorAll('.edit-question-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const index = parseInt(btn.getAttribute('data-index'));
          editQuestion(index);
        });
      });

      document.querySelectorAll('.delete-question-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const index = parseInt(btn.getAttribute('data-index'));
          deleteQuestion(index);
        });
      });
    }

    // Reset question form
    function resetQuestionForm() {
      document.getElementById('questionText').value = '';
      document.getElementById('option1').value = '';
      document.getElementById('option2').value = '';
      document.getElementById('option3').value = '';
      document.getElementById('option4').value = '';
      document.querySelector('input[name="correctOption"][value="0"]').checked = true;
      selectedQuestionIndex = null;
      isEditingQuestion = false;
      document.getElementById('questionFormTitle').textContent = 'Add New Question';
      document.getElementById('cancelEditBtn').style.display = 'none';
      document.querySelector('button[type="submit"]').textContent = 'Add Question';
      updateOptionBorders();
    }

    // Edit question
    function editQuestion(index) {
      const question = currentQuestions[index];
      document.getElementById('questionText').value = question.question;
      document.getElementById('option1').value = question.options[0];
      document.getElementById('option2').value = question.options[1];
      document.getElementById('option3').value = question.options[2];
      document.getElementById('option4').value = question.options[3];
      document.querySelector(`input[name="correctOption"][value="${question.correct}"]`).checked = true;
      selectedQuestionIndex = index;
      isEditingQuestion = true;
      document.getElementById('questionFormTitle').textContent = 'Edit Question';
      document.getElementById('cancelEditBtn').style.display = 'inline-block';
      document.querySelector('button[type="submit"]').textContent = 'Update Question';
      updateOptionBorders();
    }

    // Handle question form submission
    async function handleQuestionSubmit(e) {
      e.preventDefault();

      if (!user || !authToken) {
        showError('You must be logged in to add questions');
        return;
      }

      const questionText = document.getElementById('questionText').value;
      const option1 = document.getElementById('option1').value;
      const option2 = document.getElementById('option2').value;
      const option3 = document.getElementById('option3').value;
      const option4 = document.getElementById('option4').value;
      const correctOption = parseInt(document.querySelector('input[name="correctOption"]:checked').value);

      if (!questionText || !option1 || !option2 || !option3 || !option4) {
        showError('All fields are required');
        return;
      }

      const options = [option1, option2, option3, option4];

      try {
        if (isEditingQuestion && selectedQuestionIndex !== null) {
          // Update existing question
          const question = currentQuestions[selectedQuestionIndex];

          const updateResponse = await fetch(`${FIREBASE_DATABASE_URL}/trivia_questions/${editingTriviaId}/${question.id}.json?auth=${authToken}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              question: questionText,
              options,
              correct: correctOption
            })
          });

          if (updateResponse.ok) {
            // Update local questions array
            currentQuestions[selectedQuestionIndex] = {
              ...question,
              question: questionText,
              options,
              correct: correctOption
            };

            showSuccess('Question updated successfully!');
            resetQuestionForm();
            renderQuestionsList();
          } else {
            showError('Failed to update question');
          }
        } else {
          // Add new question
          const addResponse = await fetch(`${FIREBASE_DATABASE_URL}/trivia_questions/${editingTriviaId}.json?auth=${authToken}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              question: questionText,
              options,
              correct: correctOption
            })
          });

          const addData = await addResponse.json();

          if (addResponse.ok && addData.name) {
            // Add to local questions array
            currentQuestions.push({
              id: addData.name,
              question: questionText,
              options,
              correct: correctOption
            });

            // Update question count in trivia
            await updateQuestionCount(editingTriviaId, currentQuestions.length);

            document.getElementById('questionCount').textContent = currentQuestions.length;
            showSuccess('Question added successfully!');
            resetQuestionForm();
            renderQuestionsList();
          } else {
            showError('Failed to add question');
          }
        }
      } catch (error) {
        console.error("Question operation error:", error);
        showError('An error occurred. Please try again.');
      }
    }

    // Delete question
    async function deleteQuestion(index) {
      if (!window.confirm('Are you sure you want to delete this question?')) {
        return;
      }

      const question = currentQuestions[index];

      try {
        const deleteResponse = await fetch(`${FIREBASE_DATABASE_URL}/trivia_questions/${editingTriviaId}/${question.id}.json?auth=${authToken}`, {
          method: 'DELETE'
        });

        if (deleteResponse.ok) {
          // Remove from local questions array
          currentQuestions.splice(index, 1);

          // Update question count in trivia
          await updateQuestionCount(editingTriviaId, currentQuestions.length);

          document.getElementById('questionCount').textContent = currentQuestions.length;
          showSuccess('Question deleted successfully!');

          // If editing this question, reset the form
          if (selectedQuestionIndex === index) {
            resetQuestionForm();
          } else if (selectedQuestionIndex !== null && selectedQuestionIndex > index) {
            // Adjust selected index if we deleted a question before it
            selectedQuestionIndex--;
          }

          renderQuestionsList();
        } else {
          showError('Failed to delete question');
        }
      } catch (error) {
        console.error("Delete question error:", error);
        showError('An error occurred. Please try again.');
      }
    }

    // Update question count in trivia
    async function updateQuestionCount(triviaId, count) {
      try {
        const response = await fetch(`${FIREBASE_DATABASE_URL}/trivias/${triviaId}.json?auth=${authToken}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            question_count: count
          })
        });

        if (response.ok) {
          // Update counts in local trivia lists
          if (allTrivias.length > 0) {
            const trivia = allTrivias.find(t => t.id === triviaId);
            if (trivia) {
              trivia.question_count = count;
            }
          }

          if (myTrivias.length > 0) {
            const trivia = myTrivias.find(t => t.id === triviaId);
            if (trivia) {
              trivia.question_count = count;
            }
          }
        }
      } catch (error) {
        console.error("Update question count error:", error);
      }
    }

    // Handle sign out
    function handleSignOut() {
      // Clear authentication data
      localStorage.removeItem('triviaUser');
      localStorage.removeItem('triviaToken');
      user = null;
      userData = null;
      authToken = null;

      // Show success message
      showSuccess('Signed out successfully!');

      // Update UI
      document.getElementById('loggedIn').style.display = 'none';
      document.getElementById('loggedOut').style.display = 'flex';
      document.getElementById('loggedInNav').style.display = 'none';

      // Go back to main content
      showMainContent();

      // Hide edit buttons
      if (selectedTrivia) {
        document.getElementById('editQuestionsBtn').style.display = 'none';
      }
    }

    // Show error message
    function showError(message) {
      const errorMsg = document.getElementById('errorMessage');
      errorMsg.textContent = message;
      errorMsg.style.display = 'block';

      setTimeout(() => {
        errorMsg.style.display = 'none';
      }, 5000);
    }

    // Show success message
    function showSuccess(message) {
      const successMsg = document.getElementById('successMessage');
      successMsg.textContent = message;
      successMsg.style.display = 'block';

      setTimeout(() => {
        successMsg.style.display = 'none';
      }, 3000);
    }
  </script>
</body>
</html>